# 가입 시 이메일 인증 로드맵 (코드레벨 + Supabase/Gmail 설정)

작성일: 2026-02-03  
목표: “회원가입하면 왜 인증메일이 오고 / 메일에서 인증 클릭하면 어떻게 앱으로 돌아오는지”를 **코드 단위로 추적 가능하게** 기록한다.  
범위: Vue + Capacitor + Supabase Auth + (선택) Gmail SMTP

---

## 1) 결론부터: 이 앱의 “이메일 인증”은 누가 보내나?

이 프로젝트에서 “회원가입 인증메일 발송”은 프론트가 SMTP로 직접 보내는 구조가 아니다.

- 앱은 `supabase.auth.signUp()`을 호출한다.
- **Supabase Auth가** “이메일 인증(Confirm signup) 메일”을 발송한다.
- Supabase가 메일을 보내려면 Supabase 프로젝트에서 **SMTP 설정(기본 또는 커스텀)** 이 정상이어야 한다.

즉, `smtp.gmail.com`을 썼다면 **(대부분) Supabase Dashboard에서 SMTP Provider를 Gmail로 설정해둔 것**이다.  
프론트 리포지토리에서 SMTP 비밀번호/계정 같은 값은 보통 찾을 수 없다(보안상 있어도 안 됨).

---

## 2) 코드레벨 흐름(가입 → 인증메일 발송 안내 모달)

### 2.1 UI 진입점: Home → LoginModal → userStore.signUp

1) `app/views/Home.vue`에서 로그인/회원가입 모달을 띄움  
- `LoginModal`에서 `@show-email-verification="showEmailVerification"` 이벤트를 받음
- `EmailVerificationModal`을 표시함 (회원가입 직후 “메일 확인하세요” 안내)

2) `app/components/LoginModal.vue`에서 회원가입 처리
- 회원가입 모드일 때 `userStore.signUp(email, password, userData)` 호출

3) `app/store/user.ts`의 `signUp(...)` (핵심 요약)
- `authService.signUp(email, password, userData)` 호출
- 자동 로그인하지 않고 “이메일 인증 대기”로 UX를 구성

관련 파일:
- `app/views/Home.vue`
- `app/components/LoginModal.vue`
- `app/store/user.ts` (signUp)
- `app/components/EmailVerificationModal.vue` (인증 안내 모달)

### 2.2 실제 이메일 발송 트리거: Supabase SDK signUp

`app/services/supabase.ts`의 `authService.signUp(...)`가 실제로 Supabase Auth에 요청한다:

- 호출: `supabase.auth.signUp({ email, password, options: { emailRedirectTo, data } })`
- redirect URL 생성:
  - `baseUrl = (VITE_APP_URL || window.location.origin)` (뒤의 `/` 제거)
  - `redirectUrl = ${baseUrl}/auth/email-verified`

즉 **인증메일의 “인증하기” 버튼을 누르면 최종적으로 `/auth/email-verified`로 이동하도록** 설정되어 있다.

관련 파일:
- `app/services/supabase.ts` (authService.signUp)

---

## 3) 코드레벨 흐름(메일에서 “인증하기” 클릭 → 앱으로 콜백)

여기서 중요한 사실:

### 3.1 인증메일의 링크는 “앱으로 바로” 들어오지 않는다(현재 구조)

현재 구현은:
1) 사용자가 메일에서 “인증하기” 클릭
2) Supabase가 인증 처리(토큰 검증 등)
3) `emailRedirectTo`로 리다이렉트
4) 그 값은 **웹 URL**: `https://<도메인>/auth/email-verified`
5) 웹에서 `EmailVerified` 화면이 뜸

관련 파일:
- `app/router/index.ts` (route: `/auth/email-verified`)
- `app/views/EmailVerified.vue` (인증 완료 안내 화면)

### 3.2 웹에서 앱으로 “돌아오는” 방식(현재)

`app/views/EmailVerified.vue`의 “앱으로 열기” 버튼은:

- `window.location.href = 'com.tarotgarden.app://auth/callback'`

그리고 앱 안에서는:

- `app/utils/deepLinks.ts`가 `App.addListener('appUrlOpen', ...)`로 딥링크를 받음
- 현재 딥링크 로직은 **`auth/callback`에서 `#access_token`/`refresh_token`이 있을 때만** 정상 처리(= OAuth 로그인 콜백 목적)

즉, “이메일 인증” 딥링크는 토큰이 없기 때문에:
- 앱이 열리더라도 `/login?error=no_tokens`로 갈 가능성이 크다.

관련 파일:
- `app/views/EmailVerified.vue`
- `app/utils/deepLinks.ts`

### 3.3 “이메일 인증 → 앱 콜백”을 제대로 만들려면(개선 방향)

현실적으로 가장 안정적인 패턴은 2개 중 하나:

1) **웹 인증 완료 페이지(EmailVerified)에서 앱을 열되, 별도 딥링크 경로를 사용**
- 예: `com.tarotgarden.app://auth/email-verified`
- 앱 딥링크 핸들러(`deepLinks.ts`)에서 이 경로를 받으면:
  - 단순히 홈으로 이동 + “인증 완료, 로그인하세요” 토스트 표시

2) **Universal Links / App Links로 웹 URL 자체가 앱을 열게**
- 예: `https://<도메인>/auth/email-verified`를 클릭하면 OS가 앱으로 라우팅
- 이건 도메인 소유, AASA(ios), assetlinks(android), 앱 설정까지 필요해서 작업량이 큼

---

## 4) Supabase 설정: 무엇을 어떻게 해야 이 로직이 동작하나

Supabase Dashboard에서 “이메일 인증메일 발송”이 동작하려면 아래가 맞아야 한다.

### 4.1 URL 설정(redirect 허용 목록)

Supabase Auth는 보안상 redirect URL을 제한한다.

체크할 것:
- Site URL (프로덕션 기준 도메인)
- Additional Redirect URLs (프리뷰 도메인 포함 가능)

이 프로젝트에서 필요한 경로 예:
- `https://<프로덕션 도메인>/auth/email-verified`
- `https://<프로덕션 도메인>/auth/reset-password`
- `https://<프로덕션 도메인>/auth/callback`
- Preview를 쓴다면 `https://<your-preview>.vercel.app/auth/email-verified` 등도 추가

관련 코드 근거:
- `app/services/supabase.ts`에서 `emailRedirectTo: ${baseUrl}/auth/email-verified`

### 4.2 이메일 인증(Confirm email) 기능

Supabase Auth의 이메일 인증을 켜면:
- 가입 시 user가 “confirmed” 되기 전까지 로그인/권한이 제한됨
- 이 앱은 “가입 후 자동 로그인 안 함”으로 설계되어, 메일이 안 오면 가입 플로우가 사실상 막힘

### 4.3 SMTP Provider(가장 중요한 발송 장애 지점)

Supabase는 인증메일을 보내기 위해 SMTP가 필요하다.
옵션은 보통 2가지:

1) Supabase 기본 발송(기본 제공 SMTP)  
2) 커스텀 SMTP (예: Gmail, SendGrid, Mailgun, Resend 등)

Gmail을 썼다면, Supabase Dashboard의 SMTP 설정에 다음과 같이 들어갔을 확률이 높다:
- Host: `smtp.gmail.com`
- Port: `587`(STARTTLS) 또는 `465`(SSL)
- Username: Gmail 주소
- Password: **앱 비밀번호(App Password)** (일반 비밀번호 아님)
- From email / From name: 발신자 표시

---

## 5) Gmail 설정: “자동 발신”을 어디서 어떻게 했었나(추적 루틴)

### 5.1 Gmail SMTP를 쓰려면(개념)

“Gmail이 대신 메일을 보내준다”는 뜻은:
- Supabase가 Gmail SMTP에 로그인해서 메일을 발송한다는 뜻이다.
- 그래서 Gmail 계정이 막히면 **회원가입 인증메일이 통째로 실패**한다.

### 5.2 가장 흔한 설정: 2단계 인증 + 앱 비밀번호

개념:
- Gmail은 보안 정책 때문에 “일반 비밀번호로 SMTP 로그인”을 막는 경우가 많다.
- 그래서 보통 “2단계 인증”을 켠 뒤 “앱 비밀번호”를 만들어 SMTP에 넣는다.

### 5.3 무료 사용량 초과(쿼터)인지 확인하는 방법(가장 확실한 방법)

이건 프론트 코드에서 추측할 수 없다. **Supabase 쪽 로그/에러 메시지로 확인**해야 한다.

확인 순서(권장):
1) Supabase Dashboard에서 Auth 관련 로그/이벤트(메일 발송 실패)를 확인
2) SMTP 테스트(있다면 “테스트 메일 발송” 기능으로 즉시 확인)
3) Gmail 계정 보안 경고/차단(“의심스러운 로그인” 차단) 확인

쿼터 초과일 때 전형적인 증상:
- 특정 시간 이후부터 갑자기 인증메일이 전혀 안 옴
- resend도 동일하게 실패
- Supabase 로그에 SMTP 응답 코드/메시지가 남음(예: quota exceeded, rate limit 등)

---

## 6) 장애 복구 전략(회원가입이 막혔을 때)

### 6.1 임시 대응(사용자 영향 최소화)
- “인증메일 재전송” 버튼이 있으니, 우선 UI는 그대로 두되
- 이메일 발송 인프라부터 정상화해야 한다(대부분 SMTP 설정/쿼터 문제)

### 6.2 근본 대응(추천)
- Gmail SMTP는 개인/무료 계정에서 발송 제한/차단이 잦다.
- 인증메일/비밀번호 재설정 같은 “트랜잭션 메일”은 전용 서비스(Resend/SendGrid/Mailgun/SES)로 옮기는 것이 운영이 쉽다.

---

## 7) 이 문서를 읽은 뒤 바로 할 수 있는 “추적 체크리스트”

1) Supabase Dashboard → SMTP 설정 화면 캡처(Host/Port/From/Enabled 여부)
2) Supabase Dashboard → URL Redirect allowlist 확인(`.../auth/email-verified` 포함)
3) 최근 회원가입 시도 후 Supabase Auth 로그에서 “메일 발송 실패” 메시지 확인
4) Gmail 계정 보안 경고/로그인 차단 여부 확인

