# 가입시 이메일 인증 로드맵 (tarot-app)

작성일: 2026-02-01  
대상: “바이브코딩으로 만든 앱”을 유지보수해야 하는 미래의 나(혹은 팀원)  
목표: **회원가입 → 인증메일 발송 안내 → 이메일 링크 클릭 → 인증 완료 안내**까지의 로직/화면/환경별 분기/디버깅 방법을 문서화한다.

---

## 0) 한 줄 요약

- **회원가입 + 이메일 인증메일 발송은 Supabase Auth가 한다.**
- 앱은 회원가입 직후 **“인증메일 발송 안내 모달”**을 띄우고, 이메일 링크 클릭 시 열리는 **“인증 완료 페이지(/auth/email-verified)”**를 제공한다.
- 이 앱은 “웹 접속 차단(모바일 전용)” 정책이 있어서, **이메일 인증 완료 페이지는 웹에서도 열리도록 반드시 예외 처리(allowlist)** 해야 한다.

---

## 1) 용어/구성 요소 정리

### 사용자 입장 화면
- **LoginModal**: 로그인/회원가입 폼(이메일/소셜)
- **EmailVerificationModal**: 회원가입 직후 “메일 확인하세요” 안내 모달(문제의 ‘우측 잘림’ 이슈가 나는 화면)
- **EmailVerified 페이지**: 이메일 링크 클릭 후 뜨는 인증 완료 안내 페이지(`/auth/email-verified`)

### 시스템 구성
- **모바일 앱**: Vue SPA + Capacitor(WebView)
- **Supabase Auth**: signUp + 확인 메일 발송 + 이메일 링크 클릭 시 verify 처리 + redirectTo 이동
- **Vercel**: SPA 웹 호스팅(Preview/Production 배포)

---

## 2) 코드에서 “회원가입 이메일 인증”이 걸리는 지점(최소 지도)

### 2.1 UI 트리거 (회원가입 버튼)
- `app/views/Home.vue`
  - `LoginModal`에서 `@show-email-verification="showEmailVerification"` 이벤트를 받아서
  - `EmailVerificationModal`을 띄운다.
- `app/components/LoginModal.vue`
  - 회원가입 모드일 때 `userStore.signUp(...)` 호출

### 2.2 회원가입 로직(스토어)
- `app/store/user.ts`
  - `signUp(email, password, userData)`에서 서비스(authService) 호출
  - 성공 시 “이메일 인증 대기” 상태로 두고, UI에 모달 표시 이벤트를 쏜다(구현 방식은 컴포넌트 이벤트/스토어 상태 등)
  - `resendVerificationEmail(email)`로 재전송도 제공

### 2.3 Supabase 호출(가장 핵심)
- `app/services/supabase.ts`
  - `supabase.auth.signUp({ email, password, options: { emailRedirectTo: redirectUrl } })`
  - `redirectUrl`은 기본적으로 `.../auth/email-verified` 를 가리킨다.
  - 결론: **Supabase가 보낸 인증메일 링크를 누르면 최종적으로 `/auth/email-verified`로 온다.**

### 2.4 인증 완료 페이지 라우팅
- `app/router/index.ts`
  - `/auth/email-verified` 라우트가 존재하고 `meta: { isPublic: true }`
- `app/views/EmailVerified.vue`
  - 인증 완료 안내 UI (앱으로 열기/홈으로 이동 등)

### 2.5 “웹 접속 차단” 정책(중요)
이 프로젝트는 운영 환경에서 웹으로 접근하면 설치 유도 페이지로 보내는 로직이 있다.

- `app/utils/platformCheck.ts`
  - `checkPlatform()`이 웹 접근을 차단하고 전체 화면을 덮는 HTML을 그려버릴 수 있다.
  - 따라서 이메일 인증 링크가 웹에서 열릴 때도 차단되면 안 된다.
  - 해결 포인트: `/auth/email-verified` 같은 경로는 **alwaysAllowedPaths**에 포함되어야 한다.
- `app/main.ts`
  - 앱 부팅 초기에 `checkPlatform()`을 실행하므로, allowlist가 누락되면 라우터가 뜨기도 전에 차단 화면이 먼저 뜬다.

---

## 3) 실제 “로드맵” (플로우 기준)

### 3.1 플로우 A: 이메일 회원가입 → “인증 메일 발송 안내” 모달

1. 사용자: Home 화면에서 회원가입 진입
2. UI: `LoginModal`에서 이메일/비번/이름 입력 후 회원가입 버튼 클릭
3. Store: `userStore.signUp(email, password, userData)`
4. Service: `supabase.auth.signUp(... emailRedirectTo=/auth/email-verified ...)`
5. 결과:
   - Supabase가 인증메일 발송(사용자 이메일로 도착)
   - 앱에서는 `EmailVerificationModal`을 띄워서 “메일 확인하세요” 안내

**여기서 발생 가능한 문제**
- (1) 이메일이 아예 안 옴: SMTP/발송 인프라/스팸/차단/한도 문제
- (2) 모달 UI가 우측이 잘려 보임: WebView 뷰포트/overflow/렌더링 특성 문제

### 3.2 플로우 B: 이메일 링크 클릭 → “인증 완료” 페이지

1. 사용자: 이메일 앱/메일함에서 인증 링크 클릭
2. 브라우저(대부분 외부 브라우저): 링크가 Supabase verify 처리 후 `emailRedirectTo`로 이동
3. 우리 앱/웹:
   - `/auth/email-verified` 라우트로 진입
   - 인증 완료 안내 UI 표시

**여기서 발생 가능한 문제**
- (1) 404: SPA rewrite 설정이 없거나 라우트가 없음
- (2) “모바일 설치하라” 화면이 뜸: `checkPlatform()`이 `/auth/email-verified`를 allowlist하지 않아서 발생

---

## 4) “모달 우측 잘림”을 제대로 고치는 방법(감으로 말고 데이터로)

### 4.1 왜 이런 문제가 생기나 (가능한 원인)
모바일 WebView는 다음이 꼬이면 우측 잘림/가운데 정렬 붕괴가 빈번하다.

- `100vw`가 “실제 보이는 영역(visualViewport)”과 다름
  - 주소창, 제스처 네비게이션, 줌, 키보드 등 영향
- 상위 컨테이너(`body`, `#app`, `.app-shell`)가 `overflow: hidden`이고,
  `position: fixed` 요소가 특정 WebView에서 **클리핑**되는 버그
- 모달 내부 요소(특히 이메일 주소)가 줄바꿈이 안 되고 폭을 밀어내는 경우

### 4.2 디버깅 우선순위(가장 중요한 1개)
**“지금 보고 있는 배포가 최신이냐”부터 확정해야 한다.**
배포가 최신이 아니면 아무리 수정해도 “변화가 없다”가 당연해진다.

그래서 이 프로젝트는 디버그 오버레이에 build stamp(커밋/시간)를 찍는다.

- `app/main.ts`
  - 디버그 오버레이가 켜지면 `build: <sha> <time> mode=<...>`가 표시됨

### 4.3 디버그 오버레이 켜는 방법

#### (웹) 주소창이 있는 경우
- URL 뒤에 `?debugOverlay=1` 붙이기 (끄려면 `?debugOverlay=0`)

#### (앱) URL 입력창이 없는 경우
- **화면 좌측 상단(작은 영역)을 7번 연타** → ON/OFF 토글 후 자동 리로드
- 목적: 실기기에서 콘솔 없이도 로그를 보게 하려고 만든 기능

### 4.4 모달 “잘림”을 수치로 확인하는 방법
- `app/components/EmailVerificationModal.vue`
  - 디버그가 켜져 있으면:
    - 모달에 빨간 outline 표시
    - `modalRect / overlayRect / visualViewport` 정보를 console로 출력

**확인할 값**
- `modalRect.right`가 `window.innerWidth` 또는 `visualViewport.width`보다 크면: “모달 자체가 화면보다 큼”
- rect는 정상인데 화면이 잘려 보이면: “렌더링/클리핑/상위 컨테이너 문제” 가능성

---

## 5) SMTP 기초 설명 (비개발자/인지부채 고려)

### 5.1 SMTP란?
SMTP(Simple Mail Transfer Protocol)는 이메일을 “보내는” 표준 통신 규약이다.

쉽게 말해:
- **메일 서버 A → 메일 서버 B**로 메일을 전달할 때 쓰는 규칙
- 우리가 “가입 인증 메일”을 보내려면, 보통 아래 둘 중 하나를 한다.

1) **SMTP로 직접 보낸다**
- 우리 서버(혹은 서버리스)가 `smtp.gmail.com` 같은 SMTP 서버에 로그인해서 메일을 보냄

2) **트랜잭션 메일 서비스(API)를 쓴다**
- Resend/SendGrid/Mailgun/AWS SES 같은 서비스에 HTTP API로 “메일 보내줘” 요청
- 서비스가 대신 SMTP/전달/재시도를 처리

### 5.2 “Gmail SMTP 무료 사용량 다 됨”이 의미하는 것
일반적으로 `smtp.gmail.com`을 쓰면 발송량 제한/일시적 차단에 쉽게 걸린다.

증상 예:
- 일정 횟수 이상 보내면 에러가 나거나, 계정이 차단/보호모드로 들어감
- 갑자기 메일이 안 가거나 스팸 처리 비율이 급증

### 5.3 유료로 바꾸려면?
현실적으로 선택지는 3가지다.

1) **Google Workspace 유료 전환**
- Gmail “개인 계정”이 아니라 Workspace 도메인 계정으로 운영
- 발송 한도/관리 기능이 조금 더 명확해진다.

2) **Workspace SMTP relay(smtp-relay.gmail.com) 구성**
- 앱/서버에서 Workspace의 relay를 통해 발송
- IP 허용, TLS, 인증 정책을 Admin Console에서 설정

3) **트랜잭션 메일 서비스로 전환(권장)**
- 대량/반복 발송(인증메일, 비번재설정)은 전용 서비스가 운영이 쉽다.
- 도메인 인증(SPF/DKIM/DMARC) 세팅을 강제하는 곳이 많아 스팸률도 관리하기 좋다.

**중요(보안)**  
프론트(모바일 앱)에서 SMTP 계정/비밀번호를 가지고 직접 보내는 방식은 보안상 위험하다.
가능하면 서버(또는 서버리스)에서만 SMTP/API 키를 보관해야 한다.

---

## 6) 운영 체크리스트(문서/인지부채 최소화)

### 6.1 배포 확인 루틴
- 디버그 오버레이 켜서 `build:` 스탬프 확인
- “최신 배포 URL”을 쓰고 있는지부터 확인(Preview가 여러 개 쌓이면 헷갈림)

### 6.2 이메일 인증 테스트 루틴
- 테스트 이메일 1개 고정(스팸함/프로모션 탭까지 포함)
- 회원가입 → 모달 → 링크 클릭 → `/auth/email-verified` 노출까지 한 번에 체크
- 웹 차단 정책이 있는 경우:
  - 인증 완료 페이지는 반드시 allowlist

### 6.3 모달 UI 테스트 루틴
- 기기 1~2개를 “기준 기기”로 고정
- 아래 3개를 항상 테스트:
  - 세로/가로 회전
  - 키보드 열린 상태
  - 텍스트 길이(긴 이메일 주소)

---

## 7) 참고(관련 파일 목록)

- `app/views/Home.vue`
- `app/components/LoginModal.vue`
- `app/components/EmailVerificationModal.vue`
- `app/store/user.ts`
- `app/services/supabase.ts`
- `app/router/index.ts`
- `app/utils/platformCheck.ts`
- `app/views/EmailVerified.vue`
- `app/main.ts`

