# .github/workflows/deploy-android.yml

name: Build and Deploy Android App

# 워크플로우 실행 조건 설정
on:
  # 1. 'Actions' 탭에서 수동으로 워크플로우를 시작할 수 있도록 함 (원버튼 배포)
  workflow_dispatch:
    inputs:
      sdkVersion:
        description: 'Optional: New Target SDK Version'
        required: false

  # 2. (선택사항) main 브랜시에 코드가 푸시될 때마다 자동으로 실행
  push:
    branches: [ "dev-gemini" ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest # 실행 환경 지정

    steps:
    - name: 1. Checkout repository
      uses: actions/checkout@v4

    - name: 2. Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: 3. Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: 4. Set up Ruby and Fastlane
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: '3.1' # fastlane과 호환되는 Ruby 버전
        bundler-cache: true # Gemfile.lock을 기반으로 의존성 캐시

    - name: 5. Create Keystore and Properties from Secrets
      env:
        # GitHub Secrets에서 값을 가져와 환경 변수로 설정
        KEYSTORE_PROPERTIES: ${{ secrets.KEYSTORE_PROPERTIES }}
        GCP_SERVICE_ACCOUNT_KEY: ${{ secrets.GCP_SERVICE_ACCOUNT_KEY }}
        KEYSTORE_FILE_BASE64: ${{ secrets.KEYSTORE_FILE_BASE64 }}
      run: |
        echo "Creating secret files..."
        # Google Play API 키 파일 생성
        echo "$GCP_SERVICE_ACCOUNT_KEY" > ./android/fastlane/google-play-key.json
        
        # Keystore 프로퍼티 파일 생성
        echo "$KEYSTORE_PROPERTIES" > ./android/keystore.properties
        
        # Base64로 인코딩된 Keystore 파일을 디코딩하여 실제 파일 생성 (android 기준 경로)
        STORE_FILE=$(grep 'storeFile' ./android/keystore.properties | cut -d '=' -f2)
        echo "$KEYSTORE_FILE_BASE64" | base64 --decode > "./android/${STORE_FILE}"
        echo "Secret files created successfully."

    - name: 6. Make build script executable
      run: chmod +x ./build-and-deploy.sh

    - name: 6b. Make gradlew executable
      run: chmod +x ./android/gradlew

    - name: 7. Run Build and Deploy Script
      run: ./build-and-deploy.sh ${{ github.event.inputs.sdkVersion }}
      env:
        # fastlane 실행 시 비대화형 모드로 실행하기 위한 환경 변수
        CI: true
