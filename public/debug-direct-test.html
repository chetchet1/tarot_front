<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Premium Spread Usage Direct Test</title>
    <style>
        body {
            font-family: monospace;
            padding: 20px;
            background: #1a1a1a;
            color: #00ff00;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
        }
        h1 {
            color: #ff0000;
            text-align: center;
        }
        .log {
            background: #000;
            padding: 15px;
            border: 1px solid #00ff00;
            border-radius: 5px;
            height: 400px;
            overflow-y: auto;
            margin: 20px 0;
        }
        .log-entry {
            margin: 5px 0;
            padding: 5px;
            border-left: 3px solid #00ff00;
            padding-left: 10px;
        }
        .error {
            color: #ff0000;
            border-left-color: #ff0000;
        }
        .success {
            color: #00ff00;
            border-left-color: #00ff00;
        }
        .warning {
            color: #ffff00;
            border-left-color: #ffff00;
        }
        button {
            background: #00ff00;
            color: #000;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            cursor: pointer;
            font-weight: bold;
        }
        button:hover {
            background: #00cc00;
        }
        button.danger {
            background: #ff0000;
            color: #fff;
        }
        .status {
            background: #222;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üî¥ PREMIUM SPREAD USAGE DIRECT TEST üî¥</h1>
        
        <div class="status">
            <div>User: <span id="userEmail">-</span></div>
            <div>User ID: <span id="userId">-</span></div>
            <div>Current Time: <span id="currentTime">-</span></div>
            <div>Today's Date: <span id="todayDate">-</span></div>
        </div>
        
        <div>
            <button onclick="checkCurrentUsage()">üìä Check Current Usage</button>
            <button onclick="testDirectInsert()">üíâ Test Direct INSERT</button>
            <button onclick="testSelectQuery()">üîç Test SELECT Query</button>
            <button class="danger" onclick="deleteAllToday()">üóëÔ∏è Delete Today's Records</button>
            <button onclick="clearLog()">üßπ Clear Log</button>
        </div>
        
        <div class="log" id="log"></div>
    </div>

    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm';
        
        const supabaseUrl = 'https://tdzzmsbesbbytoehvrli.supabase.co';
        const supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRkenptc2Jlc2JieXRvZWh2cmxpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzM0MjE5MDAsImV4cCI6MjA0ODk5NzkwMH0.VcFtMEwXEGEOCVfCvT2j7az8z4IO12Z37NDPcQAmXyo';
        
        window.supabase = createClient(supabaseUrl, supabaseAnonKey);
        
        function log(message, type = 'info') {
            const logEl = document.getElementById('log');
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            const time = new Date().toLocaleTimeString('ko-KR', { hour12: false, hour: '2-digit', minute: '2-digit', second: '2-digit', millisecond: true });
            entry.textContent = `[${time}] ${message}`;
            logEl.insertBefore(entry, logEl.firstChild);
        }
        
        async function updateStatus() {
            const { data: { user } } = await supabase.auth.getUser();
            document.getElementById('userEmail').textContent = user?.email || 'Not logged in';
            document.getElementById('userId').textContent = user?.id || '-';
            document.getElementById('currentTime').textContent = new Date().toLocaleString('ko-KR');
            document.getElementById('todayDate').textContent = new Date().toISOString().split('T')[0];
        }
        
        window.checkCurrentUsage = async function() {
            log('Checking current usage...', 'warning');
            
            try {
                const { data: { user } } = await supabase.auth.getUser();
                if (!user) {
                    log('Not logged in!', 'error');
                    return;
                }
                
                const today = new Date().toISOString().split('T')[0];
                
                // Ïò§ÎäòÏùò ÏÇ¨Ïö© Í∏∞Î°ù Ï°∞Ìöå
                const { data, error } = await supabase
                    .from('premium_spread_usage')
                    .select('*')
                    .eq('user_id', user.id)
                    .eq('used_date', today);
                
                if (error) {
                    log(`Error: ${error.message}`, 'error');
                    return;
                }
                
                log(`Found ${data?.length || 0} records for today`, 'success');
                
                if (data && data.length > 0) {
                    data.forEach((record, index) => {
                        log(`Record ${index + 1}: ${record.spread_id} at ${new Date(record.used_at).toLocaleTimeString('ko-KR')}`, 'info');
                    });
                } else {
                    log('No usage today', 'success');
                }
            } catch (error) {
                log(`Exception: ${error.message}`, 'error');
            }
        };
        
        window.testDirectInsert = async function() {
            log('Testing direct INSERT...', 'warning');
            
            try {
                const { data: { user } } = await supabase.auth.getUser();
                if (!user) {
                    log('Not logged in!', 'error');
                    return;
                }
                
                // ÌÖåÏä§Ìä∏ Í≥ÑÏ†ï Í≤ΩÍ≥†
                if (user.email === 'test@example.com') {
                    log('WARNING: Test account detected!', 'warning');
                }
                
                const now = new Date();
                const today = now.toISOString().split('T')[0];
                
                log(`Attempting INSERT with user_id: ${user.id}`, 'info');
                log(`spread_id: celtic_cross`, 'info');
                log(`used_at: ${now.toISOString()}`, 'info');
                log(`used_date: ${today}`, 'info');
                
                const { data, error } = await supabase
                    .from('premium_spread_usage')
                    .insert({
                        user_id: user.id,
                        spread_id: 'celtic_cross',
                        used_at: now.toISOString(),
                        used_date: today
                    })
                    .select();
                
                if (error) {
                    log(`INSERT failed: ${error.message}`, 'error');
                    log(`Error code: ${error.code}`, 'error');
                    log(`Error details: ${JSON.stringify(error)}`, 'error');
                } else {
                    log('INSERT successful!', 'success');
                    log(`Inserted record ID: ${data[0]?.id}`, 'success');
                }
            } catch (error) {
                log(`Exception: ${error.message}`, 'error');
            }
        };
        
        window.testSelectQuery = async function() {
            log('Testing SELECT query...', 'warning');
            
            try {
                const { data: { user } } = await supabase.auth.getUser();
                if (!user) {
                    log('Not logged in!', 'error');
                    return;
                }
                
                const today = new Date().toISOString().split('T')[0];
                
                log(`Querying with user_id: ${user.id}`, 'info');
                log(`Querying with used_date: ${today}`, 'info');
                
                const { data, error, count } = await supabase
                    .from('premium_spread_usage')
                    .select('*', { count: 'exact' })
                    .eq('user_id', user.id)
                    .eq('used_date', today);
                
                if (error) {
                    log(`SELECT failed: ${error.message}`, 'error');
                } else {
                    log(`SELECT successful! Found ${data?.length || 0} records`, 'success');
                }
            } catch (error) {
                log(`Exception: ${error.message}`, 'error');
            }
        };
        
        window.deleteAllToday = async function() {
            if (!confirm('Delete all today\'s records?')) return;
            
            log('Deleting today\'s records...', 'warning');
            
            try {
                const { data: { user } } = await supabase.auth.getUser();
                if (!user) {
                    log('Not logged in!', 'error');
                    return;
                }
                
                const today = new Date().toISOString().split('T')[0];
                
                const { error } = await supabase
                    .from('premium_spread_usage')
                    .delete()
                    .eq('user_id', user.id)
                    .eq('used_date', today);
                
                if (error) {
                    log(`DELETE failed: ${error.message}`, 'error');
                } else {
                    log('DELETE successful!', 'success');
                }
            } catch (error) {
                log(`Exception: ${error.message}`, 'error');
            }
        };
        
        window.clearLog = function() {
            document.getElementById('log').innerHTML = '';
            log('Log cleared', 'success');
        };
        
        // Ï¥àÍ∏∞Ìôî
        setInterval(updateStatus, 1000);
        updateStatus();
        
        // ÌéòÏù¥ÏßÄ Î°úÎìú Ïãú ÏûêÎèô Ï≤¥ÌÅ¨
        setTimeout(() => {
            window.checkCurrentUsage();
        }, 1000);
        
        log('Direct test page loaded', 'success');
        log('This page directly calls Supabase API', 'warning');
    </script>
</body>
</html>
