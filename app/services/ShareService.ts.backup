// services/ShareService.ts
// íƒ€ë¡œ ì ê´˜ ê³µìœ  ê¸°ëŠ¥ ì„œë¹„ìŠ¤
// ì‘ì„±ì¼: 2024-12-28

import { supabase } from './supabase';
import { Share } from '@capacitor/share';
import { Capacitor } from '@capacitor/core';
import type { TarotCard, DailyInterpretation } from '../types/tarot';

// Reading ì¸í„°í˜ì´ìŠ¤ ì •ì˜
export interface Reading {
  id?: string;
  userId?: string;
  spreadId: string;
  cards: Array<{
    cardNumber?: number;
    number?: number;
    nameKr?: string;
    name_kr?: string;
    name: string;
    orientation: 'upright' | 'reversed';
    position?: {
      index: number;
      name: string;
    };
  }>;
  customQuestion?: string;
  overallMessage?: string;
  aiInterpretation?: string;
  createdAt?: Date;
}

// ê³µìœ  ë°ì´í„° ì¸í„°í˜ì´ìŠ¤
export interface SharedReading {
  id: string;  // 8ìë¦¬ ê³ ìœ  ID
  createdAt: Date;
  expiresAt: Date;
  
  // ì ê´˜ ì •ë³´
  spreadType: string;
  cards: Array<{
    cardNumber: number;
    nameKr: string;
    name: string;
    orientation: 'upright' | 'reversed';
    position?: {
      index: number;
      name: string;
    };
  }>;
  customQuestion?: string;
  
  // í•´ì„
  basicInterpretation?: string;
  aiInterpretation?: string;
  
  // ë©”íƒ€ë°ì´í„°
  sharedBy?: string;
  viewCount: number;
}

// ì˜¤ëŠ˜ì˜ ì¹´ë“œ ê³µìœ  ë°ì´í„° ì¸í„°í˜ì´ìŠ¤
export interface DailyCardShareData {
  card: TarotCard;
  interpretation: DailyInterpretation;
  date: Date;
}

export class ShareService {
  private baseUrl: string;

  constructor() {
    // í™˜ê²½ì— ë”°ë¼ URL ì„¤ì •
    this.baseUrl = import.meta.env.VITE_APP_URL || 
                   (import.meta.env.DEV ? 'http://localhost:8082' : 'https://your-app.vercel.app');
  }

  /**
   * ì¼ë°˜ ì ê´˜ ê²°ê³¼ë¥¼ ê³µìœ  ê°€ëŠ¥í•œ ë§í¬ë¡œ ìƒì„±
   */
  async createShareLink(reading: Reading): Promise<string> {
    try {
      // 1. ê³µìœ  ë°ì´í„° ì¤€ë¹„
      const shareData = {
        spread_type: reading.spreadId,
        cards: reading.cards.map(card => ({
          cardNumber: card.cardNumber || card.number || 0,
          nameKr: card.nameKr || card.name_kr || '',
          name: card.name || '',
          orientation: card.orientation || 'upright',
          position: card.position
        })),
        custom_question: reading.customQuestion || null,
        basic_interpretation: reading.overallMessage || null,
        ai_interpretation: reading.aiInterpretation || null,
        shared_by: reading.userId || null
      };
      
      console.log('Creating share link with data:', shareData);
      
      // 2. Supabaseì— ì €ì¥
      const { data, error } = await supabase
        .from('shared_readings')
        .insert(shareData)
        .select('id')
        .single();
      
      if (error) {
        console.error('Error creating share:', error);
        throw error;
      }
      
      // 3. ê³µìœ  URL ìƒì„±
      const shareUrl = `${this.baseUrl}/share/${data.id}`;
      console.log('Share URL created:', shareUrl);
      
      return shareUrl;
      
    } catch (error) {
      console.error('ê³µìœ  ë§í¬ ìƒì„± ì‹¤íŒ¨:', error);
      throw error;
    }
  }

  /**
   * ì˜¤ëŠ˜ì˜ ì¹´ë“œë¥¼ ê³µìœ  ê°€ëŠ¥í•œ ë§í¬ë¡œ ìƒì„±
   */
  async createDailyCardShareLink(data: DailyCardShareData): Promise<string> {
    try {
      // 1. ê³µìœ  ë°ì´í„° ì¤€ë¹„ (ì˜¤ëŠ˜ì˜ ì¹´ë“œìš©)
      const shareData = {
        spread_type: 'daily_card',  // ì˜¤ëŠ˜ì˜ ì¹´ë“œ êµ¬ë¶„
        cards: [{
          cardNumber: data.card.number || 0,
          nameKr: data.card.name_kr || '',
          name: data.card.name || '',
          orientation: 'upright' as const,
          position: { index: 0, name: 'ì˜¤ëŠ˜ì˜ ì¹´ë“œ' }
        }],
        custom_question: 'ì˜¤ëŠ˜ì˜ ìš´ì„¸',
        basic_interpretation: this.formatDailyInterpretation(data.interpretation),
        ai_interpretation: null,  // ì˜¤ëŠ˜ì˜ ì¹´ë“œëŠ” ì´ë¯¸ interpretationì— í¬í•¨
        shared_by: null  // ì‚¬ìš©ì IDëŠ” ShareServiceì—ì„œ ì§ì ‘ ê°€ì ¸ì˜´
      };
      
      console.log('Creating daily card share link:', shareData);
      
      // 2. Supabaseì— ì €ì¥
      const { data: savedData, error } = await supabase
        .from('shared_readings')
        .insert(shareData)
        .select('id')
        .single();
      
      if (error) {
        console.error('Error creating daily card share:', error);
        throw error;
      }
      
      // 3. ê³µìœ  URL ìƒì„±
      const shareUrl = `${this.baseUrl}/share/${savedData.id}`;
      console.log('Daily card share URL created:', shareUrl);
      
      return shareUrl;
      
    } catch (error) {
      console.error('ì˜¤ëŠ˜ì˜ ì¹´ë“œ ê³µìœ  ë§í¬ ìƒì„± ì‹¤íŒ¨:', error);
      throw error;
    }
  }

  /**
   * ê³µìœ  ë©”ì‹œì§€ ìƒì„± (ì¼ë°˜ ì ê´˜)
   */
  generateShareMessage(reading: Reading, shareUrl: string): string {
    const emoji = 'ğŸ”®';
    const title = 'íƒ€ë¡œ ì ê´˜ ê²°ê³¼ë¥¼ ê³µìœ í•©ë‹ˆë‹¤';
    
    let message = `${emoji} ${title}\n\n`;
    
    // ì§ˆë¬¸ ì¶”ê°€
    if (reading.customQuestion) {
      message += `ğŸ’­ "${reading.customQuestion}"\n\n`;
    }
    
    // ìŠ¤í”„ë ˆë“œ íƒ€ì…
    const spreadNames: Record<string, string> = {
      'one_card': '1ì¥ ë½‘ê¸°',
      'three_card_timeline': 'ì‹œê°„ì˜ íë¦„ (3ì¥)',
      'three_card_mind': 'ë§ˆìŒ íƒêµ¬ (3ì¥)',
      'celtic_cross': 'ì¼ˆí‹± í¬ë¡œìŠ¤ (10ì¥)',
      'seven_star': 'ì„¸ë¸ ìŠ¤íƒ€ (7ì¥)',
      'cup_of_relationship': 'ì—°ì• ìš´ íŠ¹í™” (7ì¥)'
    };
    message += `ğŸ“ ${spreadNames[reading.spreadId] || reading.spreadId}\n`;
    
    // ì£¼ìš” ì¹´ë“œ (ìµœëŒ€ 3ì¥)
    const mainCards = reading.cards.slice(0, 3).map(card => 
      `${card.nameKr || card.name_kr} (${card.orientation === 'upright' ? 'ì •ë°©í–¥' : 'ì—­ë°©í–¥'})`
    ).join(', ');
    message += `ğŸ´ ${mainCards}\n\n`;
    
    // ê°„ë‹¨í•œ í•´ì„ (50ì ì œí•œ)
    if (reading.aiInterpretation) {
      const shortInterpretation = reading.aiInterpretation.substring(0, 50) + '...';
      message += `âœ¨ ${shortInterpretation}\n\n`;
    } else if (reading.overallMessage) {
      const shortMessage = reading.overallMessage.substring(0, 50) + '...';
      message += `âœ¨ ${shortMessage}\n\n`;
    }
    
    // ë§í¬
    message += `ğŸ‘‰ ì „ì²´ ê²°ê³¼ ë³´ê¸°\n${shareUrl}\n\n`;
    message += `ğŸ¯ ë¬´ë£Œ íƒ€ë¡œ ì ë³´ê¸° - ë‚˜ë§Œì˜ íƒ€ë¡œ`;
    
    return message;
  }

  /**
   * ì˜¤ëŠ˜ì˜ ì¹´ë“œ ê³µìœ  ë©”ì‹œì§€ ìƒì„±
   */
  generateDailyCardShareMessage(card: TarotCard, interpretation: DailyInterpretation, shareUrl: string): string {
    const emoji = 'ğŸŒŸ';
    const title = 'ì˜¤ëŠ˜ì˜ íƒ€ë¡œ ì¹´ë“œë¥¼ ê³µìœ í•©ë‹ˆë‹¤';
    
    let message = `${emoji} ${title}\n\n`;
    
    // ë‚ ì§œ
    const today = new Date().toLocaleDateString('ko-KR', { 
      month: 'long', 
      day: 'numeric',
      weekday: 'long'
    });
    message += `ğŸ“… ${today}\n\n`;
    
    // ì¹´ë“œ ì •ë³´
    message += `ğŸ´ ì˜¤ëŠ˜ì˜ ì¹´ë“œ: ${card.name_kr}\n`;
    message += `   ${card.name}\n\n`;
    
    // ìš´ì„¸ ì§€ìˆ˜
    if (interpretation?.fortuneIndex) {
      message += `ğŸ“Š ì˜¤ëŠ˜ì˜ ìš´ì„¸\n`;
      const fortuneEmojis: Record<string, string> = {
        overall: 'ì „ì²´',
        love: 'ì• ì •',
        money: 'ê¸ˆì „',
        health: 'ê±´ê°•',
        work: 'ì—…ë¬´'
      };
      
      for (const [key, value] of Object.entries(interpretation.fortuneIndex)) {
        const stars = 'â­'.repeat(value);
        message += `${fortuneEmojis[key] || key}: ${stars}\n`;
      }
      message += '\n';
    }
    
    // í–‰ìš´ ì•„ì´í…œ
    if (interpretation?.luckyItems) {
      message += `ğŸ€ í–‰ìš´ì˜ ì•„ì´í…œ\n`;
      message += `ìƒ‰ìƒ: ${interpretation.luckyItems.color} | `;
      message += `ìˆ«ì: ${interpretation.luckyItems.number}\n\n`;
    }
    
    // ë§í¬
    message += `ğŸ‘‰ ìƒì„¸ ìš´ì„¸ ë³´ê¸°\n${shareUrl}\n\n`;
    message += `ğŸ¯ ë§¤ì¼ ë¬´ë£Œ íƒ€ë¡œ - ë‚˜ë§Œì˜ íƒ€ë¡œ`;
    
    return message;
  }

  /**
   * ë„¤ì´í‹°ë¸Œ ê³µìœ  ì‹¤í–‰
   */
  async shareWithNative(title: string, text: string, url: string): Promise<boolean> {
    try {
      // Capacitor í™˜ê²½ì¸ì§€ í™•ì¸
      if (Capacitor.isNativePlatform()) {
        // ë„¤ì´í‹°ë¸Œ ê³µìœ  API ì‚¬ìš©
        await Share.share({
          title: title,
          text: text,
          url: url,
          dialogTitle: 'ê³µìœ í•˜ê¸°'
        });
        return true;
      } else if (navigator.share) {
        // Web Share API ì§€ì› ë¸Œë¼ìš°ì €
        await navigator.share({
          title: title,
          text: text,
          url: url
        });
        return true;
      } else {
        // ê³µìœ  APIê°€ ì§€ì›ë˜ì§€ ì•ŠëŠ” ê²½ìš° í´ë¦½ë³´ë“œì— ë³µì‚¬
        const fullText = `${title}\n\n${text}\n\n${url}`;
        await navigator.clipboard.writeText(fullText);
        
        // ì‚¬ìš©ìì—ê²Œ ì•Œë¦¼ (showAlert ì‚¬ìš© ì‹œ ìˆœí™˜ ì°¸ì¡° ë°©ì§€ë¥¼ ìœ„í•´ ì§ì ‘ êµ¬í˜„)
        alert('ë§í¬ê°€ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤. ì›í•˜ëŠ” ê³³ì— ë¶™ì—¬ë„£ê¸° í•˜ì„¸ìš”.');
        return true;
      }
    } catch (error) {
      console.error('ê³µìœ  ì‹¤íŒ¨:', error);
      // ì‚¬ìš©ìê°€ ê³µìœ ë¥¼ ì·¨ì†Œí•œ ê²½ìš°ëŠ” ì—ëŸ¬ë¡œ ì²˜ë¦¬í•˜ì§€ ì•ŠìŒ
      if (error instanceof Error && error.name === 'AbortError') {
        return false;
      }
      throw error;
    }
  }

  /**
   * ê³µìœ ëœ ì ê´˜ ì¡°íšŒ
   */
  async getSharedReading(shareId: string): Promise<SharedReading | null> {
    try {
      const { data, error } = await supabase
        .from('shared_readings')
        .select('*')
        .eq('id', shareId)
        .single();
      
      if (error) {
        console.error('Error fetching shared reading:', error);
        return null;
      }
      
      // ë§Œë£Œ ì²´í¬
      if (new Date(data.expires_at) < new Date()) {
        console.log('Shared reading has expired');
        return null;
      }
      
      // ì¡°íšŒìˆ˜ ì¦ê°€ ê¸°ëŠ¥ ì œê±°ë¨
      
      return {
        id: data.id,
        createdAt: new Date(data.created_at),
        expiresAt: new Date(data.expires_at),
        spreadType: data.spread_type,
        cards: data.cards,
        customQuestion: data.custom_question,
        basicInterpretation: data.basic_interpretation,
        aiInterpretation: data.ai_interpretation,
        sharedBy: data.shared_by,
        viewCount: data.view_count
      };
      
    } catch (error) {
      console.error('ê³µìœ  ì ê´˜ ì¡°íšŒ ì‹¤íŒ¨:', error);
      return null;
    }
  }



  /**
   * ì˜¤ëŠ˜ì˜ ì¹´ë“œ í•´ì„ì„ í…ìŠ¤íŠ¸ë¡œ í¬ë§·íŒ…
   */
  private formatDailyInterpretation(interpretation: DailyInterpretation): string {
    let text = '';
    
    // ìš´ì„¸ ì§€ìˆ˜
    if (interpretation.fortuneIndex) {
      text += 'ğŸ“Š ì˜¤ëŠ˜ì˜ ìš´ì„¸ ì§€ìˆ˜\n';
      for (const [key, value] of Object.entries(interpretation.fortuneIndex)) {
        const label = this.getFortuneLabel(key);
        text += `${label}: ${'â­'.repeat(value)}\n`;
      }
      text += '\n';
    }
    
    // ìƒì„¸ ìš´ì„¸
    if (interpretation.detailedFortune) {
      text += 'ğŸ”® ì˜¤ëŠ˜ì˜ ë©”ì‹œì§€\n';
      text += interpretation.detailedFortune.mainMessage + '\n\n';
      
      if (interpretation.detailedFortune.keyPoint) {
        text += `ğŸ’« í•µì‹¬ í¬ì¸íŠ¸: ${interpretation.detailedFortune.keyPoint}\n`;
      }
      if (interpretation.detailedFortune.advice) {
        text += `ğŸ’¡ ì¡°ì–¸: ${interpretation.detailedFortune.advice}\n`;
      }
    }
    
    return text;
  }

  private getFortuneLabel(key: string): string {
    const labels: Record<string, string> = {
      overall: 'ì „ì²´ìš´',
      love: 'ì• ì •ìš´',
      money: 'ê¸ˆì „ìš´', 
      health: 'ê±´ê°•ìš´',
      work: 'í•™ì—…/ì—…ë¬´ìš´'
    };
    return labels[key] || key;
  }
}

// ì‹±ê¸€í†¤ ì¸ìŠ¤í„´ìŠ¤
export const shareService = new ShareService();
