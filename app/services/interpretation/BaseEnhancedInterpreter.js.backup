// 기본 향상된 해석기 클래스
export class BaseEnhancedInterpreter {
  constructor(topic, cards) {
    this.topic = topic;
    this.cards = cards;
  }

  // 카드 조합 패턴 분석
  analyzePatterns() {
    const patterns = [];
    
    // 메이저 아르카나 비율 분석
    const majorCount = this.cards.filter(c => c.arcana === 'major').length;
    if (majorCount >= Math.ceil(this.cards.length * 0.6)) {
      patterns.push({
        pattern_name: '운명의 전환점',
        description: '메이저 아르카나가 다수를 차지하여 중요한 인생의 전환점을 나타냅니다.',
        positions: this.cards.filter(c => c.arcana === 'major').map(c => c.position.position)
      });
    }

    // 같은 수트 연속 체크
    const suitGroups = this.groupBySuit();
    for (const [suit, cards] of Object.entries(suitGroups)) {
      if (cards.length >= 3) {
        patterns.push({
          pattern_name: `${this.getSuitName(suit)} 에너지 집중`,
          description: this.getSuitDescription(suit),
          positions: cards.map(c => c.position.position)
        });
      }
    }

    return patterns;
  }

  // 수트별 그룹화
  groupBySuit() {
    const groups = {};
    this.cards.forEach(card => {
      if (card.suit) {
        if (!groups[card.suit]) groups[card.suit] = [];
        groups[card.suit].push(card);
      }
    });
    return groups;
  }

  // 수트 이름 한글화
  getSuitName(suit) {
    const suitNames = {
      'wands': '지팡이',
      'cups': '컵',
      'swords': '검',
      'pentacles': '펜타클'
    };
    return suitNames[suit] || suit;
  }

  // 수트 설명
  getSuitDescription(suit) {
    const descriptions = {
      'wands': '열정과 창조적 에너지가 강하게 작용하고 있습니다.',
      'cups': '감정과 관계의 영역에서 중요한 변화가 있습니다.',
      'swords': '사고와 의사소통, 결정의 영역에서 활발한 움직임이 있습니다.',
      'pentacles': '물질적, 현실적인 측면에서 구체적인 변화가 나타납니다.'
    };
    return descriptions[suit] || '';
  }

  // 카드 시너지 분석
  findSynergies() {
    const synergies = [];
    
    // 특별한 조합 찾기
    for (let i = 0; i < this.cards.length; i++) {
      for (let j = i + 1; j < this.cards.length; j++) {
        const synergy = this.checkSynergy(this.cards[i], this.cards[j]);
        if (synergy) {
          synergies.push({
            card1Name: this.cards[i].nameKr,
            card2Name: this.cards[j].nameKr,
            positions: [this.cards[i].position.position, this.cards[j].position.position],
            description: synergy
          });
        }
      }
    }

    return synergies;
  }

  // 두 카드 간의 시너지 체크
  checkSynergy(card1, card2) {
    // 특별한 메이저 아르카나 조합
    if (card1.arcana === 'major' && card2.arcana === 'major') {
      // 연인과 악마
      if ((card1.number === 6 && card2.number === 15) || (card1.number === 15 && card2.number === 6)) {
        return '관계의 양면성을 보여줍니다. 순수한 사랑과 집착 사이의 균형이 필요합니다.';
      }
      // 태양과 달
      if ((card1.number === 19 && card2.number === 18) || (card1.number === 18 && card2.number === 19)) {
        return '의식과 무의식의 조화를 나타냅니다. 직관과 논리를 함께 사용하세요.';
      }
      // 죽음과 심판
      if ((card1.number === 13 && card2.number === 20) || (card1.number === 20 && card2.number === 13)) {
        return '완전한 변화와 새로운 시작을 암시합니다. 과거를 정리하고 미래로 나아가세요.';
      }
    }

    // 같은 숫자의 마이너 카드
    if (card1.arcana === 'minor' && card2.arcana === 'minor' && card1.number === card2.number) {
      return `${card1.number}번의 에너지가 강조됩니다. 이 숫자의 의미를 깊이 고민해보세요.`;
    }

    return null;
  }

  // 주제별 메시지 생성
  generateTopicMessage() {
    // 하위 클래스에서 구현
    return '';
  }

  // 전체 해석 생성
  async generateInterpretation() {
    const patterns = this.analyzePatterns();
    const synergies = this.findSynergies();
    const overallMessage = this.generateTopicMessage();
    const actionSuggestions = await this.generateActionSuggestions();
    const positionMeanings = await this.generatePositionMeanings();

    return {
      overallMessage,
      combinationPatterns: patterns,
      synergies,
      actionSuggestions,
      positionMeanings
    };
  }

  // 행동 제안 생성 (하위 클래스에서 구현)
  async generateActionSuggestions() {
    return [];
  }

  // 위치별 의미 생성 (하위 클래스에서 구현)
  async generatePositionMeanings() {
    return [];
  }
}
