// composables/useShareService.ts
// íƒ€ë¡œ ì ê´˜ ê³µìœ  ê¸°ëŠ¥ Composable
// ì‘ì„±ì¼: 2024-12-28

import { supabase } from '../services/supabase';

// ì¸í„°í˜ì´ìŠ¤ ì •ì˜
export interface Reading {
  id?: string;
  userId?: string;
  spreadId: string;
  cards: Array<{
    cardNumber?: number;
    number?: number;
    nameKr?: string;
    name_kr?: string;
    name: string;
    orientation: 'upright' | 'reversed';
    position?: {
      index: number;
      name: string;
    };
  }>;
  customQuestion?: string;
  overallMessage?: string;
  aiInterpretation?: string;
  createdAt?: Date;
}

export function useShareService() {
  const baseUrl = import.meta.env.VITE_APP_URL || 
                   (import.meta.env.DEV ? 'http://localhost:8082' : 'https://your-app.vercel.app');

  /**
   * ì¼ë°˜ ì ê´˜ ê²°ê³¼ë¥¼ ê³µìœ  ê°€ëŠ¥í•œ ë§í¬ë¡œ ìƒì„±
   */
  const createShareLink = async (reading: Reading): Promise<string> => {
    try {
      // 1. ê³µìœ  ë°ì´í„° ì¤€ë¹„
      const shareData = {
        spread_type: reading.spreadId,
        cards: reading.cards.map(card => ({
          cardNumber: card.cardNumber || card.number || 0,
          nameKr: card.nameKr || card.name_kr || '',
          name: card.name || '',
          orientation: card.orientation || 'upright',
          position: card.position
        })),
        custom_question: reading.customQuestion || null,
        basic_interpretation: reading.overallMessage || null,
        ai_interpretation: reading.aiInterpretation || null,
        shared_by: reading.userId || null
      };
      
      console.log('Creating share link with data:', shareData);
      
      // 2. Supabaseì— ì €ì¥
      const { data, error } = await supabase
        .from('shared_readings')
        .insert(shareData)
        .select('id')
        .single();
      
      if (error) {
        console.error('Error creating share:', error);
        throw error;
      }
      
      // 3. ê³µìœ  URL ìƒì„±
      const shareUrl = `${baseUrl}/share/${data.id}`;
      console.log('Share URL created:', shareUrl);
      
      return shareUrl;
      
    } catch (error) {
      console.error('ê³µìœ  ë§í¬ ìƒì„± ì‹¤íŒ¨:', error);
      throw error;
    }
  };

  /**
   * ê³µìœ  ë©”ì‹œì§€ ìƒì„±
   */
  const generateShareMessage = (reading: Reading, shareUrl: string): string => {
    let message = 'ğŸ”® íƒ€ë¡œ ì ê´˜ ê²°ê³¼ë¥¼ ê³µìœ í•©ë‹ˆë‹¤\n\n';
    
    // ì»¤ìŠ¤í…€ ì§ˆë¬¸ì´ ìˆìœ¼ë©´ í¬í•¨
    if (reading.customQuestion) {
      message += `â“ ì§ˆë¬¸: ${reading.customQuestion}\n\n`;
    }
    
    // ìŠ¤í”„ë ˆë“œ íƒ€ì…
    const spreadNames: Record<string, string> = {
      'one_card': 'ì› ì¹´ë“œ',
      'three_card_timeline': 'ì‹œê°„ì˜ íë¦„ (3ì¥)',
      'celtic_cross': 'ì¼ˆí‹± í¬ë¡œìŠ¤ (10ì¥)'
    };
    message += `ğŸ“‹ ë°°ì—´ë²•: ${spreadNames[reading.spreadId] || reading.spreadId}\n\n`;
    
    // ë½‘ì€ ì¹´ë“œë“¤
    message += 'ğŸ´ ë½‘ì€ ì¹´ë“œ:\n';
    reading.cards.forEach((card, index) => {
      const position = card.position?.name || getPositionName(reading.spreadId, index);
      const orientation = card.orientation === 'reversed' ? '(ì—­)' : '';
      message += `${index + 1}. ${position}: ${card.nameKr || card.name}${orientation}\n`;
    });
    
    message += `\nğŸ‘‰ ìì„¸í•œ í•´ì„ ë³´ê¸°\n${shareUrl}\n\n`;
    message += 'ğŸ¯ ë‚˜ë§Œì˜ íƒ€ë¡œ - ë§¤ì¼ ë¬´ë£Œ íƒ€ë¡œ ì ';
    
    return message;
  };

  /**
   * í¬ì§€ì…˜ ì´ë¦„ ê°€ì ¸ì˜¤ê¸° í—¬í¼
   */
  const getPositionName = (spreadId: string, index: number): string => {
    const positions: Record<string, string[]> = {
      'three_card_timeline': ['ê³¼ê±°', 'í˜„ì¬', 'ë¯¸ë˜'],
      'celtic_cross': [
        'í˜„ì¬ ë‚´ë©´', 'í˜„ì¬ ì™¸ë¶€', 'ê·¼ë³¸', 'ê³¼ê±°',
        'ë“œëŸ¬ë‚˜ëŠ” ëª¨ìŠµ', 'ë¯¸ë˜', 'ë‚´ê°€ ë³´ëŠ” ë‚˜',
        'ë‚¨ì´ ë³´ëŠ” ë‚˜', 'ì˜ˆìƒí•˜ëŠ” ê²°ê³¼', 'ì‹¤ì œ ê²°ê³¼'
      ]
    };
    
    return positions[spreadId]?.[index] || `ì¹´ë“œ ${index + 1}`;
  };

  /**
   * ë„¤ì´í‹°ë¸Œ ê³µìœ  ì‹¤í–‰
   */
  const shareWithNative = async (title: string, text: string, url: string): Promise<boolean> => {
    try {
      // 1. Capacitor ì²´í¬ (ë™ì ìœ¼ë¡œ ì‹œë„)
      try {
        const { Capacitor } = await import('@capacitor/core');
        if (Capacitor.isNativePlatform()) {
          const { Share } = await import('@capacitor/share');
          await Share.share({
            title: title,
            text: text,
            url: url,
            dialogTitle: 'ê³µìœ í•˜ê¸°'
          });
          return true;
        }
      } catch (e) {
        // Capacitor ì—†ìŒ - ê³„ì† ì§„í–‰
        console.log('Capacitor not available, trying Web Share API');
      }
      
      // 2. Web Share API ì§€ì› ì²´í¬
      if (navigator.share) {
        await navigator.share({
          title: title,
          text: text,
          url: url
        });
        return true;
      }
      
      // 3. í´ë¦½ë³´ë“œ ë³µì‚¬ (í´ë°±)
      const fullText = `${title}\n\n${text}\n\n${url}`;
      await navigator.clipboard.writeText(fullText);
      
      return false; // í´ë¦½ë³´ë“œ ë³µì‚¬ëŠ” false ë°˜í™˜
      
    } catch (error) {
      console.error('ê³µìœ  ì‹¤íŒ¨:', error);
      // ì‚¬ìš©ìê°€ ê³µìœ ë¥¼ ì·¨ì†Œí•œ ê²½ìš°ëŠ” ì—ëŸ¬ë¡œ ì²˜ë¦¬í•˜ì§€ ì•ŠìŒ
      if (error instanceof Error && error.name === 'AbortError') {
        return false;
      }
      throw error;
    }
  };

  return {
    createShareLink,
    generateShareMessage,
    shareWithNative
  };
}
