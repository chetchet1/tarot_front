import { defineStore } from 'pinia';
import { ref, computed } from 'vue';

export interface User {
  id: string;
  email: string;
  isPremium: boolean;
  createdAt: Date;
  dailyReadingCount: number;
  lastReadingDate: Date | null;
}

export const useUserStore = defineStore('user', () => {
  // State
  const user = ref<User | null>(null);
  const isAuthenticated = ref(false);
  const freeReadingsToday = ref(0);
  const maxFreeReadingsPerDay = 3;

  // Getters
  const isPremium = computed(() => user.value?.isPremium || false);
  const canUseFreeReading = computed(() => {
    if (isPremium.value) return true;
    return freeReadingsToday.value < maxFreeReadingsPerDay;
  });

  // Actions
  const setUser = (userData: User | null) => {
    user.value = userData;
    isAuthenticated.value = !!userData;
  };

  const incrementFreeReading = () => {
    if (!isPremium.value) {
      freeReadingsToday.value++;
    }
  };

  const resetDailyReadings = () => {
    freeReadingsToday.value = 0;
  };

  const upgradeToPremium = () => {
    if (user.value) {
      user.value.isPremium = true;
    }
  };

  // Mock 로그인 (개발용)
  const mockLogin = (email: string, premium: boolean = false) => {
    setUser({
      id: 'mock-user-123',
      email,
      isPremium: premium,
      createdAt: new Date(),
      dailyReadingCount: 0,
      lastReadingDate: null,
    });
  };

  const logout = () => {
    setUser(null);
    freeReadingsToday.value = 0;
  };

  return {
    // State
    user,
    isAuthenticated,
    freeReadingsToday,
    maxFreeReadingsPerDay,
    
    // Getters
    isPremium,
    canUseFreeReading,
    
    // Actions
    setUser,
    incrementFreeReading,
    resetDailyReadings,
    upgradeToPremium,
    mockLogin,
    logout,
  };
});
