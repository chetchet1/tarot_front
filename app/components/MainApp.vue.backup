<template>
  <div class="main-app">
    <!-- í—¤ë” -->
    <header class="app-header">
      <div class="header-content">
        <h1 class="app-title">ğŸ”® íƒ€ë¡œ ì¹´ë“œ ì ì§‘</h1>
        
        <div v-if="!userStore.isLoggedIn" class="auth-buttons">
          <button @click="showLoginModal('login')" class="login-btn">ë¡œê·¸ì¸</button>
          <button @click="showLoginModal('signup')" class="signup-btn">íšŒì›ê°€ì…</button>
        </div>
        
        <div v-else class="user-section">
          <div class="user-info">
            <span class="welcome-text">ì•ˆë…•í•˜ì„¸ìš”, {{ userStore.currentUser?.name }}ë‹˜!</span>
            <span v-if="userStore.isPremium" class="premium-badge">Premium</span>
          </div>
          
          <div class="user-menu" @click="toggleUserMenu">
            <div class="user-avatar">
              <img v-if="userStore.currentUser?.avatarUrl" 
                   :src="userStore.currentUser.avatarUrl" 
                   :alt="userStore.currentUser.name"
                   class="avatar-image" />
              <div v-else class="avatar-placeholder">
                {{ userStore.currentUser?.name?.charAt(0) || 'U' }}
              </div>
            </div>
            
            <div v-if="showUserDropdown" class="user-dropdown">
              <button @click="goToProfile" class="menu-item">
                ğŸ‘¤ í”„ë¡œí•„ ì„¤ì •
              </button>
              <button @click="goToPremium" class="menu-item">
                ğŸ’ í”„ë¦¬ë¯¸ì—„ êµ¬ë…
              </button>
              <div class="menu-divider"></div>
              <button @click="handleLogout" class="menu-item">
                ğŸšª ë¡œê·¸ì•„ì›ƒ
              </button>
            </div>
          </div>
        </div>
      </div>
    </header>

    <!-- ë©”ì¸ ì½˜í…ì¸  -->
    <main class="main-content">
      <div v-if="userStore.isLoading" class="loading-state">
        <div class="loading-spinner"></div>
        <p>íƒ€ë¡œ ì¹´ë“œë¥¼ ì¤€ë¹„í•˜ê³  ìˆìŠµë‹ˆë‹¤...</p>
      </div>
      
      <div v-else-if="userStore.isLoggedIn" class="welcome-logged-in">
        <h2>{{ getGreetingMessage() }}</h2>
        <p class="subtitle">ì˜¤ëŠ˜ì˜ ìš´ì„¸ë¥¼ í™•ì¸í•´ë³´ì„¸ìš”</p>
        
        <div class="quick-actions">
          <button @click="startReading" class="cta-button">
            ğŸ”® íƒ€ë¡œ ì  ë³´ê¸°
          </button>
          <button @click="goToHistory" class="secondary-button">
            ğŸ“š ì§€ë‚œ ì ê´˜ ë³´ê¸°
          </button>
        </div>
      </div>
      
      <div v-else class="welcome-guest">
        <h2>ì‹ ë¹„ë¡œìš´ íƒ€ë¡œì˜ ì„¸ê³„ì— ì˜¤ì‹  ê²ƒì„ í™˜ì˜í•©ë‹ˆë‹¤</h2>
        <p class="subtitle">
          íƒ€ë¡œ ì¹´ë“œë¡œ ë‹¹ì‹ ì˜ ë¯¸ë˜ë¥¼ ì—¿ë³´ê³ , ì¸ìƒì˜ ë°©í–¥ì„ ì°¾ì•„ë³´ì„¸ìš”
        </p>
        
        <div class="features-grid">
          <div class="feature-card">
            <div class="feature-icon">ğŸ”®</div>
            <h3>ì •í™•í•œ íƒ€ë¡œ ë¦¬ë”©</h3>
            <p>ì „ë¬¸ê°€ê°€ í•´ì„í•œ ì •í™•í•œ íƒ€ë¡œ ì¹´ë“œ ì˜ë¯¸ë¡œ ë‹¹ì‹ ì˜ ì§ˆë¬¸ì— ë‹µí•©ë‹ˆë‹¤</p>
          </div>
          
          <div class="feature-card">
            <div class="feature-icon">ğŸ“Š</div>
            <h3>ë‹¤ì–‘í•œ ìŠ¤í”„ë ˆë“œ</h3>
            <p>3ì¥, 5ì¥, 10ì¥ ë“± ë‹¤ì–‘í•œ ì¹´ë“œ ë°°ì—´ë¡œ ìƒí™©ì— ë§ëŠ” ì ê´˜ë¥¼ ë´…ë‹ˆë‹¤</p>
          </div>
          
          <div class="feature-card">
            <div class="feature-icon">ğŸ’«</div>
            <h3>ê°œì¸í™”ëœ í•´ì„</h3>
            <p>ë‹¹ì‹ ì˜ ìƒí™©ê³¼ ì§ˆë¬¸ì— ë§ì¶˜ ê°œì¸í™”ëœ íƒ€ë¡œ í•´ì„ì„ ì œê³µí•©ë‹ˆë‹¤</p>
          </div>
          
          <div class="feature-card">
            <div class="feature-icon">ğŸ“±</div>
            <h3>ì–¸ì œ ì–´ë””ì„œë‚˜</h3>
            <p>ëª¨ë°”ì¼ì—ì„œ ì–¸ì œë“ ì§€ í¸ë¦¬í•˜ê²Œ íƒ€ë¡œ ì ì„ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤</p>
          </div>
        </div>
        
        <div class="guest-cta">
          <button @click="showLoginModal('signup')" class="cta-button">
            ì§€ê¸ˆ ì‹œì‘í•˜ê¸°
          </button>
          <p class="cta-subtitle">íšŒì›ê°€ì…í•˜ê³  ë¬´ë£Œë¡œ íƒ€ë¡œ ì ì„ ì²´í—˜í•´ë³´ì„¸ìš”</p>
        </div>
      </div>
    </main>

    <!-- ë¡œê·¸ì¸/íšŒì›ê°€ì… ëª¨ë‹¬ -->
    <LoginModal 
      :isVisible="loginModalVisible"
      :initialMode="loginModalMode"
      @close="closeLoginModal"
      @success="handleLoginSuccess"
      @show-email-verification="showEmailVerification"
    />

    <!-- ì´ë©”ì¼ ì¸ì¦ ëª¨ë‹¬ -->
    <EmailVerificationModal
      :isVisible="emailVerificationVisible"
      :email="verificationEmail"
      @close="closeEmailVerification"
      @go-to-login="goToLoginFromVerification"
    />
  </div>
</template>

<script>
import { ref, computed, onMounted } from 'vue';
import { useUserStore } from '../store/user';
import LoginModal from './LoginModal.vue';
import EmailVerificationModal from './EmailVerificationModal.vue';

export default {
  name: 'MainApp',
  components: {
    LoginModal,
    EmailVerificationModal
  },
  setup() {
    const userStore = useUserStore();
    
    // ëª¨ë‹¬ ìƒíƒœ
    const loginModalVisible = ref(false);
    const loginModalMode = ref('login');
    const emailVerificationVisible = ref(false);
    const verificationEmail = ref('');
    
    // UI ìƒíƒœ
    const showUserDropdown = ref(false);

    // ì¸ì‚¬ë§ ë©”ì‹œì§€ ìƒì„±
    const getGreetingMessage = () => {
      const hour = new Date().getHours();
      const name = userStore.currentUser?.name || 'ê³ ê°';
      
      if (hour < 12) {
        return `ì¢‹ì€ ì•„ì¹¨ì´ì—ìš”, ${name}ë‹˜! â˜€ï¸`;
      } else if (hour < 18) {
        return `ì•ˆë…•í•˜ì„¸ìš”, ${name}ë‹˜! ğŸŒ¤ï¸`;
      } else {
        return `ì¢‹ì€ ì €ë…ì´ì—ìš”, ${name}ë‹˜! ğŸŒ™`;
      }
    };

    // ë¡œê·¸ì¸ ëª¨ë‹¬ í‘œì‹œ
    const showLoginModal = (mode = 'login') => {
      loginModalMode.value = mode;
      loginModalVisible.value = true;
      showUserDropdown.value = false;
    };

    // ë¡œê·¸ì¸ ëª¨ë‹¬ ë‹«ê¸°
    const closeLoginModal = () => {
      loginModalVisible.value = false;
    };

    // ë¡œê·¸ì¸ ì„±ê³µ ì²˜ë¦¬
    const handleLoginSuccess = (type) => {
      console.log('ë¡œê·¸ì¸ ì„±ê³µ:', type);
      closeLoginModal();
    };

    // ì´ë©”ì¼ ì¸ì¦ ëª¨ë‹¬ í‘œì‹œ
    const showEmailVerification = (email) => {
      verificationEmail.value = email;
      emailVerificationVisible.value = true;
    };

    // ì´ë©”ì¼ ì¸ì¦ ëª¨ë‹¬ ë‹«ê¸°
    const closeEmailVerification = () => {
      emailVerificationVisible.value = false;
      verificationEmail.value = '';
    };

    // ì¸ì¦ ëª¨ë‹¬ì—ì„œ ë¡œê·¸ì¸ìœ¼ë¡œ ì´ë™
    const goToLoginFromVerification = () => {
      closeEmailVerification();
      showLoginModal('login');
    };

    // ì‚¬ìš©ì ë©”ë‰´ í† ê¸€
    const toggleUserMenu = () => {
      showUserDropdown.value = !showUserDropdown.value;
    };

    // ë¡œê·¸ì•„ì›ƒ ì²˜ë¦¬
    const handleLogout = async () => {
      try {
        await userStore.logout();
        showUserDropdown.value = false;
      } catch (error) {
        console.error('ë¡œê·¸ì•„ì›ƒ ì‹¤íŒ¨:', error);
      }
    };

    // ë„¤ë¹„ê²Œì´ì…˜ í•¨ìˆ˜ë“¤
    const startReading = () => {
      console.log('íƒ€ë¡œ ì  ë³´ê¸° ì‹œì‘');
      // TODO: íƒ€ë¡œ ë¦¬ë”© í˜ì´ì§€ë¡œ ì´ë™
    };

    const goToHistory = () => {
      console.log('ì§€ë‚œ ì ê´˜ ë³´ê¸°');
      // TODO: íˆìŠ¤í† ë¦¬ í˜ì´ì§€ë¡œ ì´ë™
    };

    const goToProfile = () => {
      console.log('í”„ë¡œí•„ ì„¤ì •');
      showUserDropdown.value = false;
      // TODO: í”„ë¡œí•„ í˜ì´ì§€ë¡œ ì´ë™
    };

    const goToPremium = () => {
      console.log('í”„ë¦¬ë¯¸ì—„ êµ¬ë…');
      showUserDropdown.value = false;
      // TODO: í”„ë¦¬ë¯¸ì—„ í˜ì´ì§€ë¡œ ì´ë™
    };

    // ì™¸ë¶€ í´ë¦­ ì‹œ ë“œë¡­ë‹¤ìš´ ë‹«ê¸°
    const handleClickOutside = (event) => {
      const userMenu = event.target.closest('.user-menu');
      if (!userMenu) {
        showUserDropdown.value = false;
      }
    };

    onMounted(async () => {
      // ì‚¬ìš©ì ì´ˆê¸°í™”
      await userStore.initializeUser();
      
      // ì™¸ë¶€ í´ë¦­ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
      document.addEventListener('click', handleClickOutside);
    });

    return {
      userStore,
      loginModalVisible,
      loginModalMode,
      emailVerificationVisible,
      verificationEmail,
      showUserDropdown,
      getGreetingMessage,
      showLoginModal,
      closeLoginModal,
      handleLoginSuccess,
      showEmailVerification,
      closeEmailVerification,
      goToLoginFromVerification,
      toggleUserMenu,
      handleLogout,
      startReading,
      goToHistory,
      goToProfile,
      goToPremium
    };
  }
};
</script>

<style scoped>
.main-app {
  min-height: 100vh;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
}

/* í—¤ë” ìŠ¤íƒ€ì¼ */
.app-header {
  background: rgba(255, 255, 255, 0.1);
  backdrop-filter: blur(10px);
  border-bottom: 1px solid rgba(255, 255, 255, 0.2);
  padding: 1rem 0;
  position: sticky;
  top: 0;
  z-index: 100;
}

.header-content {
  display: flex;
  justify-content: space-between;
  align-items: center;
  max-width: 1200px;
  margin: 0 auto;
  padding: 0 2rem;
}

.app-title {
  font-size: 2rem;
  font-weight: 700;
  margin: 0;
  background: linear-gradient(45deg, #fff, #f0f9ff);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
}

.auth-buttons {
  display: flex;
  gap: 1rem;
}

.login-btn,
.signup-btn {
  padding: 0.75rem 1.5rem;
  border: none;
  border-radius: 50px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s ease;
  font-size: 1rem;
}

.login-btn {
  background: transparent;
  color: white;
  border: 2px solid rgba(255, 255, 255, 0.3);
}

.login-btn:hover {
  background: rgba(255, 255, 255, 0.1);
  border-color: rgba(255, 255, 255, 0.5);
}

.signup-btn {
  background: linear-gradient(135deg, #ff6b6b, #ee5a24);
  color: white;
  box-shadow: 0 4px 15px rgba(238, 90, 36, 0.3);
}

.signup-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 25px rgba(238, 90, 36, 0.4);
}

.user-section {
  display: flex;
  align-items: center;
  gap: 1rem;
}

.user-info {
  display: flex;
  flex-direction: column;
  align-items: flex-end;
  gap: 0.25rem;
}

.welcome-text {
  font-weight: 600;
  font-size: 1rem;
}

.premium-badge {
  background: linear-gradient(135deg, #ffd700, #ffb347);
  color: #333;
  padding: 0.2rem 0.5rem;
  border-radius: 10px;
  font-size: 0.75rem;
  font-weight: 700;
}

.user-menu {
  position: relative;
  cursor: pointer;
}

.user-avatar {
  width: 50px;
  height: 50px;
  border-radius: 50%;
  overflow: hidden;
  border: 3px solid rgba(255, 255, 255, 0.3);
  transition: border-color 0.3s ease;
}

.user-avatar:hover {
  border-color: rgba(255, 255, 255, 0.6);
}

.avatar-image {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.avatar-placeholder {
  width: 100%;
  height: 100%;
  background: linear-gradient(135deg, #ff6b6b, #ee5a24);
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 700;
  font-size: 1.2rem;
  color: white;
}

.user-dropdown {
  position: absolute;
  top: 100%;
  right: 0;
  margin-top: 0.5rem;
  background: rgba(255, 255, 255, 0.95);
  backdrop-filter: blur(10px);
  border-radius: 15px;
  box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
  border: 1px solid rgba(255, 255, 255, 0.2);
  min-width: 200px;
  overflow: hidden;
  z-index: 1000;
}

.menu-item {
  display: block;
  width: 100%;
  padding: 1rem 1.5rem;
  background: none;
  border: none;
  text-align: left;
  cursor: pointer;
  transition: background-color 0.3s ease;
  color: #333;
  font-size: 0.95rem;
  font-weight: 500;
}

.menu-item:hover {
  background: rgba(102, 126, 234, 0.1);
}

.menu-divider {
  height: 1px;
  background: rgba(0, 0, 0, 0.1);
  margin: 0.5rem 0;
}

/* ë©”ì¸ ì½˜í…ì¸  ìŠ¤íƒ€ì¼ */
.main-content {
  max-width: 1200px;
  margin: 0 auto;
  padding: 3rem 2rem;
}

.loading-state {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 4rem 2rem;
  text-align: center;
}

.loading-spinner {
  width: 60px;
  height: 60px;
  border: 4px solid rgba(255, 255, 255, 0.3);
  border-top-color: white;
  border-radius: 50%;
  animation: spin 1s linear infinite;
  margin-bottom: 1rem;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

.welcome-logged-in,
.welcome-guest {
  text-align: center;
  padding: 2rem 0;
}

.welcome-logged-in h2,
.welcome-guest h2 {
  font-size: 2.5rem;
  font-weight: 700;
  margin-bottom: 1rem;
  background: linear-gradient(45deg, #fff, #f0f9ff);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
}

.subtitle {
  font-size: 1.2rem;
  opacity: 0.9;
  margin-bottom: 3rem;
  line-height: 1.6;
}

.quick-actions {
  display: flex;
  gap: 1rem;
  justify-content: center;
  flex-wrap: wrap;
  margin-top: 2rem;
}

.cta-button,
.secondary-button {
  padding: 1rem 2rem;
  border: none;
  border-radius: 50px;
  font-size: 1.1rem;
  font-weight: 700;
  cursor: pointer;
  transition: all 0.3s ease;
  min-width: 180px;
}

.cta-button {
  background: linear-gradient(135deg, #ff6b6b, #ee5a24);
  color: white;
  box-shadow: 0 4px 15px rgba(238, 90, 36, 0.3);
}

.cta-button:hover {
  transform: translateY(-3px);
  box-shadow: 0 8px 25px rgba(238, 90, 36, 0.4);
}

.secondary-button {
  background: transparent;
  color: white;
  border: 2px solid rgba(255, 255, 255, 0.3);
}

.secondary-button:hover {
  background: rgba(255, 255, 255, 0.1);
  border-color: rgba(255, 255, 255, 0.5);
  transform: translateY(-2px);
}

.features-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
  gap: 2rem;
  margin: 3rem 0;
}

.feature-card {
  background: rgba(255, 255, 255, 0.1);
  backdrop-filter: blur(10px);
  border-radius: 20px;
  padding: 2rem;
  text-align: center;
  border: 1px solid rgba(255, 255, 255, 0.2);
  transition: all 0.3s ease;
}

.feature-card:hover {
  transform: translateY(-5px);
  background: rgba(255, 255, 255, 0.15);
  box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
}

.feature-icon {
  font-size: 3rem;
  margin-bottom: 1rem;
}

.feature-card h3 {
  font-size: 1.4rem;
  font-weight: 600;
  margin-bottom: 1rem;
  color: white;
}

.feature-card p {
  opacity: 0.9;
  line-height: 1.6;
  font-size: 1rem;
}

.guest-cta {
  margin-top: 4rem;
  text-align: center;
}

.cta-subtitle {
  margin-top: 1rem;
  opacity: 0.8;
  font-size: 1rem;
}

/* ë°˜ì‘í˜• ë””ìì¸ */
@media (max-width: 768px) {
  .header-content {
    padding: 0 1rem;
  }
  
  .app-title {
    font-size: 1.5rem;
  }
  
  .auth-buttons {
    gap: 0.5rem;
  }
  
  .login-btn,
  .signup-btn {
    padding: 0.5rem 1rem;
    font-size: 0.9rem;
  }
  
  .main-content {
    padding: 1.5rem 1rem;
  }
  
  .welcome-logged-in h2,
  .welcome-guest h2 {
    font-size: 2rem;
  }
  
  .features-grid {
    grid-template-columns: 1fr;
    gap: 1rem;
  }
  
  .feature-card {
    padding: 1.5rem;
  }
  
  .user-dropdown {
    right: -1rem;
    left: -1rem;
    margin-top: 1rem;
  }
}

@media (max-width: 480px) {
  .user-info {
    display: none;
  }
  
  .user-menu-toggle {
    margin-left: auto;
  }
  
  .app-title {
    font-size: 1.2rem;
  }
  
  .auth-buttons {
    flex-direction: column;
    gap: 0.5rem;
  }
}

/* ë‹¤í¬ëª¨ë“œ ìµœì í™” */
@media (prefers-color-scheme: dark) {
  .user-dropdown {
    background: rgba(30, 30, 30, 0.95);
  }
  
  .menu-item {
    color: white;
  }
  
  .menu-item:hover {
    background: rgba(255, 255, 255, 0.1);
  }
  
  .menu-divider {
    background: rgba(255, 255, 255, 0.2);
  }
}

/* ì ‘ê·¼ì„± ê°œì„  */
@media (prefers-reduced-motion: reduce) {
  * {
    animation-duration: 0.01ms !important;
    animation-iteration-count: 1 !important;
    transition-duration: 0.01ms !important;
  }
}

/* í¬ì»¤ìŠ¤ í‘œì‹œ */
button:focus,
.feature-card:focus {
  outline: 2px solid rgba(255, 255, 255, 0.8);
  outline-offset: 2px;
}

/* í˜¸ë²„ íš¨ê³¼ ë¹„í™œì„±í™” (í„°ì¹˜ ë””ë°”ì´ìŠ¤) */
@media (hover: none) {
  .feature-card:hover,
  .login-btn:hover,
  .signup-btn:hover,
  .cta-button:hover {
    transform: none;
    box-shadow: initial;
  }
}
</style>
