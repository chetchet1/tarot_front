/**
 * ì„¸ë¸ ìŠ¤íƒ€ ë°°ì—´ë²• ì „ìš© ê°•í™”ëœ ì¸í„°í”„ë¦¬í„°
 */

import { 
  TarotCard, 
  findSynergyPatterns, 
  extractTopicKeywords,
  analyzeCardRelationships,
  validateInterpretationCoherence,
  postProcessAIResponse
} from './interpretationUtils';

export class EnhancedSevenStarInterpreter {
  private readonly positions = [
    { position: 1, name: 'í•µì‹¬', description: 'í˜„ì¬ ìƒí™©ì˜ ì¤‘ì‹¬ì´ ë˜ëŠ” ì—ë„ˆì§€' },
    { position: 2, name: 'ë„ì›€', description: 'ë‹¹ì‹ ì„ ë•ëŠ” ê¸ì •ì ì¸ í˜' },
    { position: 3, name: 'ë‚´ë©´', description: 'ë‚´ë©´ì˜ ê°ì •ê³¼ ë¬´ì˜ì‹ì  ì˜í–¥' },
    { position: 4, name: 'ì˜ˆìƒ', description: 'ì˜ˆìƒë˜ëŠ” ë„ì „ì´ë‚˜ ê¸°íšŒ' },
    { position: 5, name: 'ê²°ê³¼', description: 'í˜„ì¬ ê²½ë¡œë¥¼ ë”°ë¥¼ ë•Œì˜ ê°€ëŠ¥í•œ ê²°ê³¼' },
    { position: 6, name: 'ì™¸ë¶€', description: 'ì™¸ë¶€ í™˜ê²½ê³¼ íƒ€ì¸ì˜ ì˜í–¥' },
    { position: 7, name: 'ìš´ëª…', description: 'ìš´ëª…ì  ë©”ì‹œì§€ì™€ ìˆ¨ê²¨ì§„ ê°€ëŠ¥ì„±' }
  ];
  
  /**
   * AIë¥¼ ìœ„í•œ êµ¬ì¡°í™”ëœ í”„ë¡¬í”„íŠ¸ ìƒì„±
   */
  generateStructuredPromptForAI(
    cards: TarotCard[], 
    topic: string,
    customQuestion?: string
  ): string {
    const patterns = findSynergyPatterns(cards);
    const keywords = extractTopicKeywords(topic);
    const relationships = analyzeCardRelationships(cards);
    
    let prompt = `ë‹¹ì‹ ì€ ê²½í—˜ ë§ì€ íƒ€ë¡œ ë§ˆìŠ¤í„°ì…ë‹ˆë‹¤. ì„¸ë¸ ìŠ¤íƒ€ ë°°ì—´ë²•ìœ¼ë¡œ ${topic}ì— ëŒ€í•œ ê¹Šì´ ìˆëŠ” í•´ì„ì„ ì œê³µí•´ì£¼ì„¸ìš”.\n\n`;
    
    // ì—°ì•  ì¹´í…Œê³ ë¦¬ì¼ ê²½ìš° íŠ¹ë³„ ì§€ì¹¨ ì¶”ê°€
    if (topic === 'ì—°ì• ' || topic.includes('ì‚¬ë‘') || topic.includes('ì—°ì• ')) {
      prompt += `ã€ì¤‘ìš” ì§€ì¹¨ã€‘\n`;
      prompt += `ì§ˆë¬¸ìì˜ ì—°ì•  ìƒíƒœë¥¼ ì•Œ ìˆ˜ ì—†ìœ¼ë¯€ë¡œ, ë‹¤ìŒ ë‘ ê°€ì§€ ê²½ìš°ë¥¼ ëª¨ë‘ ê³ ë ¤í•˜ì—¬ í•´ì„í•´ì£¼ì„¸ìš”:\n`;
      prompt += `1. í˜„ì¬ ì†”ë¡œì¸ ê²½ìš°: ìƒˆë¡œìš´ ë§Œë‚¨ì˜ ê°€ëŠ¥ì„±, ì—°ì•  ì¤€ë¹„ ìƒíƒœ, ìê¸° ê°œë°œ í•„ìš”ì„± ë“±\n`;
      prompt += `2. í˜„ì¬ ì—°ì¸ì´ ìˆëŠ” ê²½ìš°: ê´€ê³„ ë°œì „ ë°©í–¥, ìƒëŒ€ë°©ê³¼ì˜ ì¡°í™”, ê°ì •ì  êµë¥˜ ë“±\n`;
      prompt += `ë‘ ê°€ì§€ ê²½ìš°ë¥¼ ëª¨ë‘ ì–¸ê¸‰í•˜ë˜, ìì—°ìŠ¤ëŸ½ê²Œ í†µí•©í•˜ì—¬ ì„¤ëª…í•´ì£¼ì„¸ìš”.\n\n`;
    }
    
    if (customQuestion) {
      prompt += `ã€ì§ˆë¬¸ìì˜ êµ¬ì²´ì  ì§ˆë¬¸ã€‘\n${customQuestion}\n\n`;
    }
    
    prompt += `ã€ì¹´ë“œ ë°°ì—´ã€‘\n`;
    cards.forEach((card, index) => {
      const pos = this.positions[index];
      prompt += `${pos.position}. ${pos.name} (${pos.description}): ${card.nameKr || card.name_kr} - ${card.orientation === 'upright' ? 'ì •ë°©í–¥' : 'ì—­ë°©í–¥'}\n`;
    });
    prompt += '\n';
    
    // íŒ¨í„´ ë¶„ì„
    if (patterns.length > 0) {
      prompt += `ã€ë°œê²¬ëœ íŒ¨í„´ã€‘\n`;
      patterns.forEach(pattern => {
        prompt += `â€¢ ${pattern}\n`;
      });
      prompt += '\n';
    }
    
    // ì¹´ë“œ ê´€ê³„ ë¶„ì„
    prompt += `ã€ì¹´ë“œ ê°„ ê´€ê³„ã€‘\n`;
    if (relationships.complementary.length > 0) {
      prompt += `â€¢ ë³´ì™„ ê´€ê³„: ${relationships.complementary.map(([i, j]) => 
        `${cards[i].position.name}-${cards[j].position.name}`).join(', ')}\n`;
    }
    if (relationships.supporting.length > 0) {
      prompt += `â€¢ ì§€ì› ê´€ê³„: ${relationships.supporting.map(([i, j]) => 
        `${cards[i].position.name}-${cards[j].position.name}`).join(', ')}\n`;
    }
    if (relationships.conflicting.length > 0) {
      prompt += `â€¢ ê°ˆë“± ê´€ê³„: ${relationships.conflicting.map(([i, j]) => 
        `${cards[i].position.name}-${cards[j].position.name}`).join(', ')}\n`;
    }
    prompt += '\n';
    
    // í•´ì„ ê°€ì´ë“œë¼ì¸
    prompt += `ã€í•´ì„ ê°€ì´ë“œë¼ì¸ã€‘
1. ê° ìœ„ì¹˜ì˜ ì¹´ë“œê°€ ì „ì²´ ì´ì•¼ê¸°ì—ì„œ ì–´ë–¤ ì—­í• ì„ í•˜ëŠ”ì§€ ì„¤ëª…
2. í•µì‹¬(1ë²ˆ) ì¹´ë“œë¥¼ ì¤‘ì‹¬ìœ¼ë¡œ ë‹¤ë¥¸ ì¹´ë“œë“¤ê³¼ì˜ ì—°ê²°ì„± ë¶„ì„
3. ë„ì›€(2ë²ˆ)ê³¼ ì™¸ë¶€(6ë²ˆ)ì˜ ìƒí˜¸ì‘ìš© ì„¤ëª…
4. ë‚´ë©´(3ë²ˆ)ê³¼ ì˜ˆìƒ(4ë²ˆ)ì´ ê²°ê³¼(5ë²ˆ)ì— ë¯¸ì¹˜ëŠ” ì˜í–¥ ë¶„ì„
5. ìš´ëª…(7ë²ˆ) ì¹´ë“œê°€ ì œì‹œí•˜ëŠ” ë” í° ê·¸ë¦¼ê³¼ ë©”ì‹œì§€
6. ê¸ì •ì ì´ê³  í¬ë§ì ì¸ ë©”ì‹œì§€ë¡œ ë§ˆë¬´ë¦¬
7. ${keywords.join(', ')}ì™€ ê´€ë ¨ëœ êµ¬ì²´ì  ì¡°ì–¸ ì œê³µ

ã€ì‘ë‹µ í˜•ì‹ã€‘
1. ì „ì²´ì ì¸ ì—ë„ˆì§€ì™€ ìƒí™© ê°œìš” (2-3ë¬¸ì¥)
2. í•µì‹¬ ë©”ì‹œì§€ì™€ ì¤‘ìš” í¬ì¸íŠ¸ (3-4ë¬¸ì¥)
3. ê° ìœ„ì¹˜ë³„ ìƒì„¸ í•´ì„ (ê° 2-3ë¬¸ì¥)
4. ì¹´ë“œë“¤ ê°„ì˜ ì‹œë„ˆì§€ì™€ ë©”ì‹œì§€ (2-3ë¬¸ì¥)
5. ì‹¤ì²œì  ì¡°ì–¸ê³¼ ì œì•ˆ (3-4ë¬¸ì¥)
6. ê¸ì •ì ì´ê³  í¬ë§ì ì¸ ë§ˆë¬´ë¦¬ ë©”ì‹œì§€ (1-2ë¬¸ì¥)

ìì—°ìŠ¤ëŸ½ê³  ê³µê°ì ì¸ í†¤ìœ¼ë¡œ ì‘ì„±í•˜ë˜, êµ¬ì²´ì ì´ê³  ì‹¤ìš©ì ì¸ ì¡°ì–¸ì„ í¬í•¨í•´ì£¼ì„¸ìš”.`;
    
    return prompt;
  }
  
  /**
   * ê¸°ë³¸ í•´ì„ ìƒì„± (í´ë°±ìš©)
   */
  generateBasicInterpretation(
    cards: TarotCard[], 
    topic: string
  ): string {
    const patterns = findSynergyPatterns(cards);
    const keywords = extractTopicKeywords(topic);
    
    let interpretation = `ğŸŒŸ ì„¸ë¸ ìŠ¤íƒ€ê°€ ì „í•˜ëŠ” ${topic} ë©”ì‹œì§€ ğŸŒŸ\n\n`;
    
    // ì „ì²´ ê°œìš”
    interpretation += `ë‹¹ì‹ ì˜ ${topic}ì— ëŒ€í•œ 7ì¥ì˜ ì¹´ë“œê°€ ë³„ìë¦¬ì²˜ëŸ¼ í¼ì³ì¡ŒìŠµë‹ˆë‹¤.\n`;
    
    // ì—°ì•  ì¹´í…Œê³ ë¦¬ì¼ ê²½ìš° íŠ¹ë³„ ì•ˆë‚´
    if (topic === 'ì—°ì• ' || topic.includes('ì‚¬ë‘') || topic.includes('ì—°ì• ')) {
      interpretation += `(ì´ í•´ì„ì€ í˜„ì¬ ì—°ì¸ì´ ìˆëŠ” ë¶„ê³¼ ì†”ë¡œì¸ ë¶„ ëª¨ë‘ì—ê²Œ í•´ë‹¹í•©ë‹ˆë‹¤)\n`;
    }
    interpretation += `\n`;
    
    // í•µì‹¬ ì¹´ë“œ í•´ì„
    const coreCard = cards[0];
    interpretation += `\nâ—† í•µì‹¬ ì—ë„ˆì§€: ${coreCard.nameKr || coreCard.name_kr}\n`;
    interpretation += `í˜„ì¬ ìƒí™©ì˜ ì¤‘ì‹¬ì—ëŠ” ${coreCard.nameKr || coreCard.name_kr}ì˜ `;
    interpretation += coreCard.orientation === 'upright' ? 'ì •ë°©í–¥ ' : 'ì—­ë°©í–¥ ';
    interpretation += `ì—ë„ˆì§€ê°€ ìë¦¬í•˜ê³  ìˆìŠµë‹ˆë‹¤.\n`;
    
    // ë„ì›€ê³¼ ë°©í•´ ìš”ì†Œ
    const helpCard = cards[1];
    const externalCard = cards[5];
    interpretation += `\nâ—† ì˜í–¥ë ¥\n`;
    interpretation += `â€¢ ë„ì›€: ${helpCard.nameKr || helpCard.name_kr} - ë‹¹ì‹ ì„ ì§€ì›í•˜ëŠ” í˜\n`;
    interpretation += `â€¢ ì™¸ë¶€: ${externalCard.nameKr || externalCard.name_kr} - ì£¼ë³€ í™˜ê²½ì˜ ì˜í–¥\n`;
    
    // ë‚´ë©´ê³¼ ì˜ˆìƒ
    const innerCard = cards[2];
    const expectCard = cards[3];
    interpretation += `\nâ—† ë‚´ì  ê³¼ì •\n`;
    interpretation += `â€¢ ë‚´ë©´: ${innerCard.nameKr || innerCard.name_kr} - ë§ˆìŒ ì† ê¹Šì€ ê³³ì˜ ë©”ì‹œì§€\n`;
    interpretation += `â€¢ ì˜ˆìƒ: ${expectCard.nameKr || expectCard.name_kr} - ë‹¤ê°€ì˜¬ ë„ì „ê³¼ ê¸°íšŒ\n`;
    
    // ê²°ê³¼ì™€ ìš´ëª…
    const resultCard = cards[4];
    const destinyCard = cards[6];
    interpretation += `\nâ—† ë¯¸ë˜ì˜ ê°€ëŠ¥ì„±\n`;
    interpretation += `â€¢ ê²°ê³¼: ${resultCard.nameKr || resultCard.name_kr} - í˜„ì¬ ê²½ë¡œì˜ ë„ì°©ì \n`;
    interpretation += `â€¢ ìš´ëª…: ${destinyCard.nameKr || destinyCard.name_kr} - ìš°ì£¼ê°€ ì „í•˜ëŠ” íŠ¹ë³„í•œ ë©”ì‹œì§€\n`;
    
    // íŒ¨í„´ ì–¸ê¸‰
    if (patterns.length > 0) {
      interpretation += `\nâ—† íŠ¹ë³„í•œ íŒ¨í„´\n`;
      patterns.forEach(pattern => {
        interpretation += `â€¢ ${pattern}\n`;
      });
    }
    
    // ì¡°ì–¸
    interpretation += `\nâ—† ì¡°ì–¸\n`;
    
    // ì—°ì•  ì¹´í…Œê³ ë¦¬ì¼ ê²½ìš° íŠ¹ë³„ ì¡°ì–¸
    if (topic === 'ì—°ì• ' || topic.includes('ì‚¬ë‘') || topic.includes('ì—°ì• ')) {
      interpretation += `í˜„ì¬ ì—°ì¸ì´ ìˆë‹¤ë©´, ${coreCard.nameKr || coreCard.name_kr}ì˜ ì—ë„ˆì§€ë¥¼ í†µí•´ ê´€ê³„ë¥¼ ë”ìš± ê¹Šê²Œ ë§Œë“¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤. `;
      interpretation += `ì†”ë¡œë¼ë©´, ${helpCard.nameKr || helpCard.name_kr}ì˜ ê¸ì •ì  ì—ë„ˆì§€ê°€ ìƒˆë¡œìš´ ë§Œë‚¨ì„ ì´ëŒì–´ë‚¼ ê²ƒì…ë‹ˆë‹¤. `;
      interpretation += `ì–´ë–¤ ìƒí™©ì´ë“  ${keywords[0]}ì™€ ${keywords[1]}ì— ì´ˆì ì„ ë§ì¶”ì„¸ìš”.\n`;
    } else {
      interpretation += `${keywords[0]}ì™€ ${keywords[1]}ì— ì´ˆì ì„ ë§ì¶”ì–´ ë‚˜ì•„ê°€ì„¸ìš”. `;
      interpretation += `íŠ¹íˆ ${coreCard.nameKr || coreCard.name_kr}ê°€ ì œì‹œí•˜ëŠ” ë°©í–¥ì„ ì‹ ë¢°í•˜ë©°, `;
      interpretation += `${helpCard.nameKr || helpCard.name_kr}ì˜ ê¸ì •ì  ì—ë„ˆì§€ë¥¼ í™œìš©í•˜ì‹œê¸° ë°”ëë‹ˆë‹¤.\n`;
    }
    
    // ë§ˆë¬´ë¦¬
    interpretation += `\nâœ¨ ë³„ë“¤ì´ ë‹¹ì‹ ì˜ ê¸¸ì„ ë°ê²Œ ë¹„ì¶”ê¸°ë¥¼ ë°”ëë‹ˆë‹¤. âœ¨`;
    
    return interpretation;
  }
  
  /**
   * AI ì‘ë‹µ ê²€ì¦ ë° ë³´ì •
   */
  validateAIResponse(response: string): string {
    // ê¸°ë³¸ ê²€ì¦
    if (!response || response.length < 200) {
      console.warn('AI ì‘ë‹µì´ ë„ˆë¬´ ì§§ìŠµë‹ˆë‹¤. ê¸°ë³¸ í•´ì„ì„ ë°˜í™˜í•©ë‹ˆë‹¤.');
      return this.generateBasicInterpretation([], 'general');
    }
    
    // ì¼ê´€ì„± ê²€ì¦
    if (!validateInterpretationCoherence(response)) {
      console.warn('AI ì‘ë‹µì˜ êµ¬ì¡°ê°€ ë¶ˆì™„ì „í•©ë‹ˆë‹¤. í›„ì²˜ë¦¬ë¥¼ ì ìš©í•©ë‹ˆë‹¤.');
      response = this.enhanceResponseStructure(response);
    }
    
    // í›„ì²˜ë¦¬
    return postProcessAIResponse(response);
  }
  
  /**
   * ì‘ë‹µ êµ¬ì¡° ê°•í™”
   */
  private enhanceResponseStructure(response: string): string {
    const lines = response.split('\n');
    const enhanced: string[] = [];
    
    // ì„¹ì…˜ í—¤ë” ì¶”ê°€
    let hasIntro = false;
    let hasConclusion = false;
    
    for (let i = 0; i < lines.length; i++) {
      const line = lines[i].trim();
      
      // ë„ì…ë¶€ í™•ì¸
      if (i === 0 && !line.startsWith('â—†') && !line.startsWith('ã€')) {
        enhanced.push('â—† ì „ì²´ì ì¸ ìƒí™©\n');
        hasIntro = true;
      }
      
      enhanced.push(lines[i]);
      
      // ë§ˆì§€ë§‰ ë¶€ë¶„ í™•ì¸
      if (i === lines.length - 1 && !hasConclusion) {
        enhanced.push('\nâ—† ë§ˆë¬´ë¦¬ ë©”ì‹œì§€');
        enhanced.push('ì¹´ë“œë“¤ì´ ì „í•˜ëŠ” ë©”ì‹œì§€ë¥¼ ì‹ ë¢°í•˜ë©° ì•ìœ¼ë¡œ ë‚˜ì•„ê°€ì„¸ìš”.');
        hasConclusion = true;
      }
    }
    
    return enhanced.join('\n');
  }
  
  /**
   * í¬ì§€ì…˜ë³„ í•µì‹¬ í‚¤ì›Œë“œ ì¶”ì¶œ
   */
  extractPositionKeywords(card: TarotCard, positionIndex: number): string[] {
    const positionKeywords: Record<number, string[]> = {
      0: ['ì¤‘ì‹¬', 'í•µì‹¬', 'í˜„ì¬', 'ì£¼ìš” ì—ë„ˆì§€'],
      1: ['ì§€ì›', 'ë„ì›€', 'ê¸ì •ì  í˜', 'ìš°í˜¸ì '],
      2: ['ë‚´ë©´', 'ê°ì •', 'ë¬´ì˜ì‹', 'ìˆ¨ê²¨ì§„'],
      3: ['ì˜ˆìƒ', 'ë„ì „', 'ê¸°íšŒ', 'ê°€ëŠ¥ì„±'],
      4: ['ê²°ê³¼', 'ë„ì°©ì ', 'ì„±ê³¼', 'ë¯¸ë˜'],
      5: ['ì™¸ë¶€', 'í™˜ê²½', 'íƒ€ì¸', 'ì˜í–¥'],
      6: ['ìš´ëª…', 'ìˆ¨ê²¨ì§„ ë©”ì‹œì§€', 'ë” í° ê·¸ë¦¼', 'ì‹ ì„±í•œ ì¡°ì–¸']
    };
    
    return positionKeywords[positionIndex] || ['ì¹´ë“œ', 'ë©”ì‹œì§€'];
  }
  
  /**
   * íŠ¹ë³„í•œ ì¹´ë“œ ì¡°í•© ê°ì§€
   */
  detectSpecialCombinations(cards: TarotCard[]): string[] {
    const combinations: string[] = [];
    
    // í•µì‹¬ê³¼ ê²°ê³¼ê°€ ê°™ì€ ìŠˆíŠ¸
    if (cards[0].suit && cards[0].suit === cards[4].suit) {
      combinations.push('í•µì‹¬ê³¼ ê²°ê³¼ê°€ ê°™ì€ ì—ë„ˆì§€ë¡œ ì—°ê²°ë˜ì–´ ìˆìŠµë‹ˆë‹¤.');
    }
    
    // ë„ì›€ê³¼ ì™¸ë¶€ê°€ ëŒ€ë¦½
    if (cards[1].orientation !== cards[5].orientation) {
      combinations.push('ë‚´ë¶€ì˜ ë„ì›€ê³¼ ì™¸ë¶€ í™˜ê²½ì´ ë‹¤ë¥¸ ë°©í–¥ì„ ê°€ë¦¬í‚µë‹ˆë‹¤.');
    }
    
    // ë‚´ë©´ê³¼ ì˜ˆìƒì´ ì¡°í™”
    if (cards[2].suit === cards[3].suit && cards[2].orientation === cards[3].orientation) {
      combinations.push('ë‚´ë©´ì˜ ì†Œë¦¬ì™€ ì˜ˆìƒì´ ì¡°í™”ë¥¼ ì´ë£¨ê³  ìˆìŠµë‹ˆë‹¤.');
    }
    
    // ìš´ëª… ì¹´ë“œê°€ ë©”ì´ì € ì•„ë¥´ì¹´ë‚˜
    if (cards[6].arcana === 'major') {
      combinations.push('ìš´ëª…ì˜ ë©”ì‹œì§€ê°€ íŠ¹ë³„íˆ ê°•ë ¥í•©ë‹ˆë‹¤.');
    }
    
    return combinations;
  }
}
